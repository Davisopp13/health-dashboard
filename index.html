<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sketch Health</title>

    <!-- Favicon - Updated Sketch Health Logo -->
    <link rel="icon" type="image/svg+xml"
        href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 200 200'%3E%3Crect x='10' y='10' width='180' height='180' fill='%23FEF9C3' stroke='%231E3A8A' stroke-width='2' rx='4'/%3E%3Cpath d='M100 165 C85 152, 40 122, 40 85 C40 58, 58 45, 75 45 C88 45, 96 52, 100 62 C104 52, 112 45, 125 45 C142 45, 160 58, 160 85 C160 122, 115 152, 100 165 Z' stroke='%231E3A8A' stroke-width='5' fill='none' stroke-linecap='round' stroke-linejoin='round' stroke-dasharray='2,1'/%3E%3Cline x1='30' y1='95' x2='170' y2='95' stroke='%231E3A8A' stroke-width='6' stroke-linecap='round'/%3E%3Crect x='20' y='75' width='18' height='40' stroke='%231E3A8A' stroke-width='4' fill='none' rx='3'/%3E%3Cline x1='23' y1='80' x2='33' y2='110' stroke='%231E3A8A' stroke-width='2'/%3E%3Cline x1='26' y1='80' x2='36' y2='105' stroke='%231E3A8A' stroke-width='2'/%3E%3Cline x1='29' y1='80' x2='36' y2='95' stroke='%231E3A8A' stroke-width='2'/%3E%3Crect x='162' y='75' width='18' height='40' stroke='%231E3A8A' stroke-width='4' fill='none' rx='3'/%3E%3Cline x1='165' y1='80' x2='175' y2='110' stroke='%231E3A8A' stroke-width='2'/%3E%3Cline x1='168' y1='80' x2='178' y2='105' stroke='%231E3A8A' stroke-width='2'/%3E%3Cline x1='171' y1='80' x2='178' y2='95' stroke='%231E3A8A' stroke-width='2'/%3E%3Cg transform='translate(135, 30) rotate(35)'%3E%3Crect x='0' y='0' width='10' height='45' fill='%2360A5FA' stroke='%231E3A8A' stroke-width='2.5' rx='1'/%3E%3Cpolygon points='5,45 0,52 10,52' fill='%231E3A8A'/%3E%3Crect x='0' y='-6' width='10' height='6' fill='%2393C5FD' stroke='%231E3A8A' stroke-width='2' rx='1'/%3E%3Cline x1='0' y1='-3' x2='10' y2='-3' stroke='%231E3A8A' stroke-width='1'/%3E%3C/g%3E%3C/svg%3E">

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Kalam:wght@400;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kalam', cursive;
            background-color: #FEF9C3;
            /* Yellow notepad color */
            color: #1E3A8A;
            /* Dark blue ink color */
            background-image: repeating-linear-gradient(to bottom, transparent, transparent 28px, #BFDBFE 29px, #BFDBFE 29px);
            line-height: 29px;
            padding-top: 29px;
            /* Align content with lines */
        }

        /* Create the red margin line */
        body::before {
            content: '';
            position: absolute;
            top: 0;
            left: 40px;
            bottom: 0;
            width: 2px;
            background-color: #F87171;
            /* Red margin color */
        }

        .card {
            background-color: transparent;
            border: none;
            border-radius: 0;
            padding: 1.5rem;
            box-shadow:
                2px 2px 4px rgba(0, 0, 0, 0.1),
                inset 0 0 0 2px rgba(191, 219, 254, 0.3);
            position: relative;
        }

        /* Torn paper edge effect */
        .card::after {
            content: '';
            position: absolute;
            top: -3px;
            left: 0;
            right: 0;
            height: 6px;
            background-image:
                repeating-linear-gradient(90deg,
                    transparent,
                    transparent 10px,
                    rgba(191, 219, 254, 0.5) 10px,
                    rgba(191, 219, 254, 0.5) 11px);
        }

        .btn {
            border: 2px solid #1E3A8A;
            border-radius: 4px;
            padding: 0.5rem 1.25rem;
            font-weight: 700;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            box-shadow: 2px 2px 0px #93C5FD;
        }

        .btn:active {
            box-shadow: 0px 0px 0px #93C5FD;
            transform: translate(2px, 2px);
        }

        .btn-primary {
            background-color: #1E3A8A;
            color: white;
        }

        .btn-primary:hover {
            background-color: #1D4ED8;
        }

        .btn-secondary {
            background-color: transparent;
            color: #1E3A8A;
        }

        .btn-secondary:hover {
            background-color: rgba(191, 219, 254, 0.3);
        }

        .btn-danger {
            background-color: #1E3A8A;
            color: white;
        }

        .btn-danger:hover {
            background-color: #1D4ED8;
        }

        .progress-bar {
            background-color: rgba(191, 219, 254, 0.4);
            border: 1px solid #60A5FA;
            border-radius: 2px;
            overflow: hidden;
            height: 1.25rem;
        }

        .progress-bar-fill {
            background-color: #60A5FA;
            /* Blue highlighter */
            transition: width 0.6s cubic-bezier(0.65, 0, 0.35, 1);
            height: 100%;
        }

        /* Pulse animation when goal is reached */
        .progress-bar-fill.goal-reached {
            animation: pulse-glow 2s infinite;
        }

        @keyframes pulse-glow {

            0%,
            100% {
                box-shadow: 0 0 5px rgba(96, 165, 250, 0.5);
            }

            50% {
                box-shadow: 0 0 20px rgba(96, 165, 250, 0.8);
            }

        }

        /* Meal Tab Buttons */
        .meal-tab-btn {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
            font-weight: 600;
            border: 2px solid #1E3A8A;
            background-color: white;
            color: #1E3A8A;
            border-radius: 0.375rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .meal-tab-btn:hover {
            background-color: #EFF6FF;
        }

        .meal-tab-btn.active {
            background-color: #1E3A8A;
            color: white;
        }

        input,
        select {
            font-family: 'Kalam', cursive;
            border: 2px solid #1E3A8A;
            border-radius: 4px;
            background-color: #FEFCE8;
            /* Slightly lighter yellow for inputs */
        }

        input[type="checkbox"]:checked+span {
            text-decoration: line-through;
            color: #6B7280;
        }

        input[type="checkbox"] {
            appearance: none;
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            background-color: transparent;
            border: 2px solid #1E3A8A;
            border-radius: 2px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        input[type="checkbox"]:after {
            content: '✓';
            font-size: 18px;
            font-weight: 700;
            color: #1E3A8A;
            display: none;
        }

        input[type="checkbox"]:checked:after {
            display: block;
        }

        .tab-btn {
            padding: 0.5rem 1rem;
            border-radius: 4px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s;
            border: 2px solid transparent;
        }

        .tab-btn.active {
            background-color: #1E3A8A;
            color: white;
            border: 2px solid #1E3A8A;
        }

        .tab-btn:not(.active) {
            color: #1D4ED8;
        }

        /* Custom styles for overriding Tailwind inside notepad */
        .notepad-text {
            color: #1E3A8A;
        }

        .notepad-text-light {
            color: #3B82F6;
        }

        .notepad-text-faded {
            color: #60A5FA;
        }

        .notepad-header {
            color: #1E3A8A;
        }
    </style>
</head>

<body class="py-4 sm:py-6 md:py-8 pr-4 sm:pr-6 md:pr-8 pl-16 md:pl-20">

    <div id="loading-container" class="fixed inset-0 bg-yellow-100 flex items-center justify-center z-50">
        <div class="text-center">
            <svg class="animate-spin h-10 w-10 text-blue-800 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none"
                viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor"
                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                </path>
            </svg>
            <p class="mt-4 text-lg text-blue-700">Loading...</p>
        </div>
    </div>

    <div id="landing-page-container" class="hidden">
        <div class="min-h-screen flex flex-col items-center justify-center text-center px-4">
            <!-- Logo Icon - Heart with Dumbbell and Pencil -->
            <svg class="w-32 h-32 md:w-40 md:h-40 mb-4" viewBox="0 0 200 200" fill="none"
                xmlns="http://www.w3.org/2000/svg">
                <!-- Heart outline with sketchy style -->
                <path
                    d="M100 165 C85 152, 40 122, 40 85 C40 58, 58 45, 75 45 C88 45, 96 52, 100 62 C104 52, 112 45, 125 45 C142 45, 160 58, 160 85 C160 122, 115 152, 100 165 Z"
                    stroke="#1E3A8A" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"
                    stroke-dasharray="2,1" />

                <!-- Dumbbell bar through heart -->
                <line x1="30" y1="95" x2="170" y2="95" stroke="#1E3A8A" stroke-width="6" stroke-linecap="round" />

                <!-- Left dumbbell weight with hatching -->
                <rect x="20" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none" rx="3" />
                <line x1="23" y1="80" x2="33" y2="110" stroke="#1E3A8A" stroke-width="2" />
                <line x1="26" y1="80" x2="36" y2="105" stroke="#1E3A8A" stroke-width="2" />
                <line x1="29" y1="80" x2="36" y2="95" stroke="#1E3A8A" stroke-width="2" />

                <!-- Right dumbbell weight with hatching -->
                <rect x="162" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none" rx="3" />
                <line x1="165" y1="80" x2="175" y2="110" stroke="#1E3A8A" stroke-width="2" />
                <line x1="168" y1="80" x2="178" y2="105" stroke="#1E3A8A" stroke-width="2" />
                <line x1="171" y1="80" x2="178" y2="95" stroke="#1E3A8A" stroke-width="2" />

                <!-- Pencil drawing the heart (top right) -->
                <g transform="translate(135, 30) rotate(35)">
                    <!-- Pencil body -->
                    <rect x="0" y="0" width="10" height="45" fill="#60A5FA" stroke="#1E3A8A" stroke-width="2.5"
                        rx="1" />
                    <!-- Pencil tip -->
                    <polygon points="5,45 0,52 10,52" fill="#1E3A8A" />
                    <!-- Pencil eraser -->
                    <rect x="0" y="-6" width="10" height="6" fill="#93C5FD" stroke="#1E3A8A" stroke-width="2" rx="1" />
                    <!-- Eraser band -->
                    <line x1="0" y1="-3" x2="10" y2="-3" stroke="#1E3A8A" stroke-width="1" />
                </g>
            </svg>

            <h1 class="text-6xl md:text-7xl font-bold notepad-header leading-tight">
                Sketch Health
            </h1>
            <p class="mt-4 max-w-2xl text-lg text-blue-700">
                Your personal health journey, sketched out. Track workouts, monitor nutrition with AI, and build lasting
                habits.
            </p>
            <div class="mt-8 flex flex-col sm:flex-row items-center justify-center gap-4">
                <button id="googleSignUpBtn" class="btn btn-primary w-full sm:w-auto text-lg px-8 py-3">
                    Sign Up for Free
                </button>
            </div>
            <p class="mt-4 text-sm text-gray-500">
                Already have an account?
                <button id="googleSignInBtn" class="text-blue-800 hover:text-blue-600 font-bold">Log in</button>
            </p>
            <div id="auth-error" class="text-red-600 mt-4 text-sm h-5"></div>
        </div>
    </div>
    <!-- Onboarding Modal -->
    <div id="onboarding-modal"
        class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div
            class="bg-yellow-100 rounded-lg p-8 max-w-2xl mx-4 border-4 border-blue-800 shadow-2xl transform transition-all">
            <!-- Step 1: Welcome -->
            <div id="onboarding-step-1" class="onboarding-step">
                <div class="text-center mb-6">
                    <!-- Logo -->
                    <svg class="w-24 h-24 mx-auto mb-4" viewBox="0 0 200 200" fill="none"
                        xmlns="http://www.w3.org/2000/svg">
                        <path
                            d="M100 165 C85 152, 40 122, 40 85 C40 58, 58 45, 75 45 C88 45, 96 52, 100 62 C104 52, 112 45, 125 45 C142 45, 160 58, 160 85 C160 122, 115 152, 100 165 Z"
                            stroke="#1E3A8A" stroke-width="5" fill="none" stroke-linecap="round" stroke-linejoin="round"
                            stroke-dasharray="2,1" />
                        <line x1="30" y1="95" x2="170" y2="95" stroke="#1E3A8A" stroke-width="6"
                            stroke-linecap="round" />
                        <rect x="20" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none"
                            rx="3" />
                        <line x1="23" y1="80" x2="33" y2="110" stroke="#1E3A8A" stroke-width="2" />
                        <line x1="26" y1="80" x2="36" y2="105" stroke="#1E3A8A" stroke-width="2" />
                        <line x1="29" y1="80" x2="36" y2="95" stroke="#1E3A8A" stroke-width="2" />
                        <rect x="162" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none"
                            rx="3" />
                        <line x1="165" y1="80" x2="175" y2="110" stroke="#1E3A8A" stroke-width="2" />
                        <line x1="168" y1="80" x2="178" y2="105" stroke="#1E3A8A" stroke-width="2" />
                        <line x1="171" y1="80" x2="178" y2="95" stroke="#1E3A8A" stroke-width="2" />
                        <g transform="translate(135, 30) rotate(35)">
                            <rect x="0" y="0" width="10" height="45" fill="#60A5FA" stroke="#1E3A8A" stroke-width="2.5"
                                rx="1" />
                            <polygon points="5,45 0,52 10,52" fill="#1E3A8A" />
                            <rect x="0" y="-6" width="10" height="6" fill="#93C5FD" stroke="#1E3A8A" stroke-width="2"
                                rx="1" />
                            <line x1="0" y1="-3" x2="10" y2="-3" stroke="#1E3A8A" stroke-width="1" />
                        </g>
                    </svg>
                </div>
                <h2 class="text-3xl font-bold notepad-header mb-4 text-center">Welcome to Sketch Health! 📝💪</h2>
                <p class="text-lg mb-6 text-center text-blue-700">Let's personalize your fitness journey in just a few
                    quick steps.</p>
                <button class="btn btn-primary w-full text-lg" onclick="app.onboarding.nextStep()">Get Started</button>
            </div>

            <!-- Step 2: Goal Selection -->
            <div id="onboarding-step-2" class="onboarding-step hidden">
                <h2 class="text-2xl font-bold notepad-header mb-6 text-center">What's your primary fitness goal?</h2>
                <div class="space-y-3">
                    <button class="btn btn-secondary w-full text-left py-4 px-6 hover:bg-blue-100 transition-colors"
                        onclick="app.onboarding.selectGoal('build_muscle')">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">💪</span>
                            <div>
                                <p class="font-bold text-lg">Build Muscle</p>
                                <p class="text-sm text-blue-600">Focus on strength training and progressive overload</p>
                            </div>
                        </div>
                    </button>
                    <button class="btn btn-secondary w-full text-left py-4 px-6 hover:bg-blue-100 transition-colors"
                        onclick="app.onboarding.selectGoal('lose_weight')">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">🏃</span>
                            <div>
                                <p class="font-bold text-lg">Lose Weight</p>
                                <p class="text-sm text-blue-600">Emphasize cardio and calorie tracking</p>
                            </div>
                        </div>
                    </button>
                    <button class="btn btn-secondary w-full text-left py-4 px-6 hover:bg-blue-100 transition-colors"
                        onclick="app.onboarding.selectGoal('maintain_fitness')">
                        <div class="flex items-center">
                            <span class="text-3xl mr-4">⚖️</span>
                            <div>
                                <p class="font-bold text-lg">Maintain Fitness</p>
                                <p class="text-sm text-blue-600">Stay healthy with balanced workouts</p>
                            </div>
                        </div>
                    </button>
                </div>
            </div>

            <!-- Step 3: Daily Goals -->
            <div id="onboarding-step-3" class="onboarding-step hidden">
                <h2 class="text-2xl font-bold notepad-header mb-6 text-center">Set Your Daily Goals</h2>
                <div class="space-y-5">
                    <div>
                        <label class="block font-bold mb-2 text-blue-900">💧 Water Goal (glasses/day)</label>
                        <input type="number" id="onboarding-water-goal" value="8" min="1" max="20"
                            class="w-full px-4 py-3 text-lg border-2 border-blue-800 rounded">
                        <p class="text-sm text-blue-600 mt-1">Recommended: 8 glasses (64 oz)</p>
                    </div>
                    <div>
                        <label class="block font-bold mb-2 text-blue-900">🥤 Max Liquid Calories (kcal/day)</label>
                        <input type="number" id="onboarding-liquid-goal" value="500" min="0" max="2000" step="50"
                            class="w-full px-4 py-3 text-lg border-2 border-blue-800 rounded">
                        <p class="text-sm text-blue-600 mt-1">Includes sodas, juices, alcohol, etc.</p>
                    </div>
                    <div>
                        <!-- Workout Builder Modal -->
                        <div id="workout-builder-modal"
                            class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50 overflow-y-auto">
                            <div
                                class="bg-yellow-100 rounded-lg p-8 max-w-4xl mx-4 my-8 border-4 border-blue-800 max-h-[90vh] overflow-y-auto">
                                <div class="flex justify-between items-center mb-6">
                                    <h2 class="text-3xl font-bold notepad-header">Custom Workout Builder</h2>
                                    <button onclick="app.workoutBuilder.close()" class="btn btn-secondary">✕
                                        Close</button>
                                </div>

                                <!-- Workout Name -->
                                <div class="mb-6">
                                    <label class="block font-bold mb-2 text-blue-900">Workout Name</label>
                                    <input type="text" id="custom-workout-name" placeholder="e.g., My Chest Day"
                                        class="w-full px-4 py-2 border-2 border-blue-800 rounded">
                                </div>

                                <!-- Duration Estimate -->
                                <div class="mb-6">
                                    <label class="block font-bold mb-2 text-blue-900">Estimated Duration
                                        (minutes)</label>
                                    <input type="number" id="custom-workout-duration" value="45" min="5" max="180"
                                        class="w-full px-4 py-2 border-2 border-blue-800 rounded">
                                </div>

                                <!-- Exercise List -->
                                <div class="mb-6">
                                    <div class="flex justify-between items-center mb-4">
                                        <h3 class="text-xl font-bold notepad-header">Exercises</h3>
                                        <button onclick="app.workoutBuilder.addExercise()" class="btn btn-primary">+ Add
                                            Exercise</button>
                                    </div>

                                    <div id="custom-exercises-list" class="space-y-4">
                                        <!-- Exercise items will be added here dynamically -->
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex gap-4">
                                    <button onclick="app.workoutBuilder.save()" class="btn btn-primary flex-1">💾 Save
                                        Workout</button>
                                    <button onclick="app.workoutBuilder.close()"
                                        class="btn btn-secondary flex-1">Cancel</button>
                                </div>
                            </div>
                        </div>

                        <!-- Exercise Item Template -->
                        <template id="exercise-item-template">
                            <div class="exercise-item bg-white p-4 rounded-lg border-2 border-blue-800 relative">
                                <div class="flex gap-4 items-start">
                                    <div class="flex-1 space-y-3">
                                        <input type="text" placeholder="Exercise name (e.g., Bench Press)"
                                            class="exercise-name w-full px-3 py-2 border-2 border-blue-800 rounded font-semibold">
                                        <div class="grid grid-cols-3 gap-3">
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold mb-1 text-blue-900">Sets</label>
                                                <input type="number"
                                                    class="exercise-sets w-full px-3 py-2 border-2 border-blue-800 rounded"
                                                    value="3" min="1" max="10">
                                            </div>
                                            <div>
                                                <label
                                                    class="block text-sm font-semibold mb-1 text-blue-900">Reps</label>
                                                <input type="text"
                                                    class="exercise-reps w-full px-3 py-2 border-2 border-blue-800 rounded"
                                                    value="10-12" placeholder="8-12 or 60s">
                                            </div>
                                            <div>
                                                <label class="block text-sm font-semibold mb-1 text-blue-900">Rest
                                                    (sec)</label>
                                                <input type="number"
                                                    class="exercise-rest w-full px-3 py-2 border-2 border-blue-800 rounded"
                                                    value="90" min="30" max="300" step="15">
                                            </div>
                                        </div>
                                    </div>
                                    <button class="btn btn-danger btn-sm mt-8"
                                        onclick="app.workoutBuilder.removeExercise(this)">✕</button>
                                </div>
                            </div>
                        </template>

                        <label class="block font-bold mb-2 text-blue-900">🏋️ Workout Days per Week</label>
                        <input type="number" id="onboarding-workout-days" value="3" min="1" max="7"
                            class="w-full px-4 py-3 text-lg border-2 border-blue-800 rounded">
                        <p class="text-sm text-blue-600 mt-1">We'll help you stay consistent!</p>
                    </div>
                </div>
                <button class="btn btn-primary w-full mt-8 text-lg py-4" onclick="app.onboarding.complete()">
                    🎉 Start My Journey!
                </button>
            </div>
        </div>
    </div>


    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <!-- Header -->
        <header class="mb-6">
            <div class="border border-blue-100 rounded-xl px-6 py-4 shadow-sm">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-3">
                        <!-- Heart + Dumbbell + Pencil Logo (Compact Header Version) -->
                        <svg class="w-8 h-8 flex-shrink-0" viewBox="0 0 200 200" fill="none"
                            xmlns="http://www.w3.org/2000/svg">
                            <!-- Heart outline with sketchy style -->
                            <path
                                d="M100 165 C85 152, 40 122, 40 85 C40 58, 58 45, 75 45 C88 45, 96 52, 100 62 C104 52, 112 45, 125 45 C142 45, 160 58, 160 85 C160 122, 115 152, 100 165 Z"
                                stroke="#1E3A8A" stroke-width="5" fill="none" stroke-linecap="round"
                                stroke-linejoin="round" stroke-dasharray="2,1" />

                            <!-- Dumbbell bar through heart -->
                            <line x1="30" y1="95" x2="170" y2="95" stroke="#1E3A8A" stroke-width="6"
                                stroke-linecap="round" />

                            <!-- Left dumbbell weight with hatching -->
                            <rect x="20" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none"
                                rx="3" />
                            <line x1="23" y1="80" x2="33" y2="110" stroke="#1E3A8A" stroke-width="2" />
                            <line x1="26" y1="80" x2="36" y2="105" stroke="#1E3A8A" stroke-width="2" />
                            <line x1="29" y1="80" x2="36" y2="95" stroke="#1E3A8A" stroke-width="2" />

                            <!-- Right dumbbell weight with hatching -->
                            <rect x="162" y="75" width="18" height="40" stroke="#1E3A8A" stroke-width="4" fill="none"
                                rx="3" />
                            <line x1="165" y1="80" x2="175" y2="110" stroke="#1E3A8A" stroke-width="2" />
                            <line x1="168" y1="80" x2="178" y2="105" stroke="#1E3A8A" stroke-width="2" />
                            <line x1="171" y1="80" x2="178" y2="95" stroke="#1E3A8A" stroke-width="2" />

                            <!-- Pencil drawing the heart (top right) -->
                            <g transform="translate(135, 30) rotate(35)">
                                <!-- Pencil body -->
                                <rect x="0" y="0" width="10" height="45" fill="#60A5FA" stroke="#1E3A8A"
                                    stroke-width="2.5" rx="1" />
                                <!-- Pencil tip -->
                                <polygon points="5,45 0,52 10,52" fill="#1E3A8A" />
                                <!-- Pencil eraser -->
                                <rect x="0" y="-6" width="10" height="6" fill="#93C5FD" stroke="#1E3A8A"
                                    stroke-width="2" rx="1" />
                                <!-- Eraser band -->
                                <line x1="0" y1="-3" x2="10" y2="-3" stroke="#1E3A8A" stroke-width="1" />
                            </g>
                        </svg>
                        <h1 class="text-2xl font-bold notepad-header">Sketch Health</h1>
                    </div>
                    <div class="flex items-center gap-4">
                        <p id="welcomeMessage" class="text-base font-semibold text-blue-700 hidden sm:block">Welcome
                            back, Davis!</p>
                        <!-- User Profile Icon with Dropdown -->
                        <div class="relative">
                            <button id="profileBtn"
                                class="w-10 h-10 rounded-full bg-blue-600 text-white flex items-center justify-center font-bold hover:bg-blue-700 transition-colors">
                                D
                            </button>
                            <div id="profileDropdown"
                                class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border-2 border-blue-800 py-2 z-10">
                                <button id="logoutBtn"
                                    class="w-full text-left px-4 py-2 hover:bg-blue-50 text-blue-900 font-semibold">
                                    Log out
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="mt-4">
                <div class="h-px bg-gray-200"></div>
            </div>
        </header>

        <!-- Highlights Bar -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
            <div class="card flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-xl mb-2 notepad-header">Workout Streak</h2>
                    <p id="lastWorkoutDate" class="text-sm text-blue-400 mt-1">No workouts yet.</p>
                </div>
                <div class="flex items-baseline text-right">
                    <span id="workoutStreakDisplay" class="text-6xl font-bold notepad-header">0</span>
                    <span class="text-xl font-semibold ml-2 text-blue-700">Days</span>
                </div>
            </div>
            <div class="card flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-xl mb-2 notepad-header">Total Excess Calories</h2>
                    <p class="text-sm text-blue-400 mt-1">Logged from snacks & extras.</p>
                </div>
                <div class="flex items-baseline text-right">
                    <span id="excessCaloriesDisplay" class="text-6xl font-bold notepad-header">0</span>
                    <span class="text-xl font-semibold ml-2 text-blue-700">kcal</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">
            <div class="lg:col-span-3 space-y-6">
                <div class="card p-6">
                    <div>
                        <div class="flex justify-between items-center mb-4">
                            <h2 class="font-bold text-xl notepad-header">Today's Workouts</h2>
                            <button onclick="app.workoutBuilder.open()" class="btn btn-secondary btn-sm py-2 px-4">
                                ✏️ Create Custom Workout
                            </button>
                        </div>
                        <div class="mb-4">
                            <select id="workoutSelector" class="w-full px-3 py-2">
                                <option value="none">-- Add a workout to your day --</option>
                                <option value="home_abs">Home Ab Workout (15 Mins)</option>
                                <option value="gym_push">Gym: Push Day (45 Mins)</option>
                                <option value="gym_pull">Gym: Pull Day (45 Mins)</option>
                                <option value="gym_legs">Gym: Legs Day (45 Mins)</option>
                                <option value="cardio">Cardio</option>
                                <option value="rest_day">Rest Day</option>
                            </select>
                        </div>
                        <div id="workoutStack" class="space-y-6"></div>
                    </div>
                    <hr class="border-blue-200 my-8">
                    <div>
                        <h2 class="font-bold text-xl mb-4 notepad-header">Log Meals with AI</h2>

                        <!-- Meal Type Selector -->
                        <div class="flex gap-2 mb-4">
                            <button id="breakfastTabBtn" class="meal-tab-btn active"
                                onclick="app.selectMealType('breakfast')">🌅 Breakfast</button>
                            <button id="lunchTabBtn" class="meal-tab-btn" onclick="app.selectMealType('lunch')">☀️
                                Lunch</button>
                            <button id="dinnerTabBtn" class="meal-tab-btn" onclick="app.selectMealType('dinner')">🌙
                                Dinner</button>
                            <button id="snacksTabBtn" class="meal-tab-btn" onclick="app.selectMealType('snacks')">🍿
                                Snacks</button>
                        </div>

                        <!-- Food Input -->
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input id="foodDescInput" type="text" placeholder="Describe your food..."
                                class="px-3 py-2 w-full">
                            <button id="logFoodBtn" class="btn btn-primary" onclick="app.addMealWithAI()">
                                <span id="logFoodText">Calculate & Log</span>
                                <svg id="logFoodSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </button>
                        </div>

                        <!-- Meal Lists -->
                        <div class="space-y-4">
                            <div id="breakfastSection" class="meal-section">
                                <h3 class="font-semibold notepad-header mb-2">🌅 Breakfast</h3>
                                <div id="breakfastList" class="space-y-2 text-sm"></div>
                            </div>
                            <div id="lunchSection" class="meal-section hidden">
                                <h3 class="font-semibold notepad-header mb-2">☀️ Lunch</h3>
                                <div id="lunchList" class="space-y-2 text-sm"></div>
                            </div>
                            <div id="dinnerSection" class="meal-section hidden">
                                <h3 class="font-semibold notepad-header mb-2">🌙 Dinner</h3>
                                <div id="dinnerList" class="space-y-2 text-sm"></div>
                            </div>
                            <div id="snacksSection" class="meal-section hidden">
                                <h3 class="font-semibold notepad-header mb-2">🍿 Snacks</h3>
                                <div id="snacksList" class="space-y-2 text-sm"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="lg:col-span-2 space-y-6">
                <div class="card p-6">
                    <h2 class="font-bold text-xl mb-4 notepad-header">Nutrition Hub</h2>
                    <div class="mb-6">
                        <h3 class="font-semibold notepad-header mb-2">Liquid Calories</h3>
                        <p class="text-2xl font-bold notepad-header"><span id="liquidCaloriesDisplay">0</span> / 500
                            kcal</p>
                        <div class="progress-bar mt-2 mb-4">
                            <div id="liquidCaloriesBar" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-3 text-sm">
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(150)">Soda (150)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(120)">Juice (120)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(210)">Choc. Milk
                                (210)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(180)">Latte (180)</button>
                        </div>
                    </div>

                    <!-- Macronutrient Tracking -->
                    <div class="mb-6">
                        <h3 class="font-semibold notepad-header mb-3">Daily Macros</h3>

                        <!-- Protein -->
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold text-blue-800">Protein</span>
                                <span class="text-blue-600"><span id="proteinDisplay">0</span> / 150g</span>
                            </div>
                            <div class="progress-bar">
                                <div id="proteinBar" class="progress-bar-fill"
                                    style="width: 0%; background-color: #EF4444;"></div>
                            </div>
                        </div>

                        <!-- Carbs -->
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold text-blue-800">Carbs</span>
                                <span class="text-blue-600"><span id="carbsDisplay">0</span> / 200g</span>
                            </div>
                            <div class="progress-bar">
                                <div id="carbsBar" class="progress-bar-fill"
                                    style="width: 0%; background-color: #F59E0B;"></div>
                            </div>
                        </div>

                        <!-- Fat -->
                        <div class="mb-3">
                            <div class="flex justify-between text-sm mb-1">
                                <span class="font-semibold text-blue-800">Fat</span>
                                <span class="text-blue-600"><span id="fatDisplay">0</span> / 65g</span>
                            </div>
                            <div class="progress-bar">
                                <div id="fatBar" class="progress-bar-fill"
                                    style="width: 0%; background-color: #10B981;"></div>
                            </div>
                        </div>

                        <!-- Total Calories from Meals -->
                        <div class="mt-4 p-3 bg-blue-50 rounded-md">
                            <div class="flex justify-between items-center">
                                <span class="font-semibold text-blue-900">Total Calories</span>
                                <span class="text-2xl font-bold notepad-header text-blue-900"
                                    id="totalCaloriesDisplay">0</span>
                            </div>
                        </div>
                    </div>

                    <div>
                        <h3 class="font-semibold notepad-header mb-2">Water Intake</h3>
                        <p class="text-2xl font-bold notepad-header"><span id="waterIntakeDisplay">0</span> / 8 Glasses
                        </p>
                        <div class="progress-bar mt-2 mb-4">
                            <div id="waterIntakeBar" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="flex"><button class="btn btn-secondary w-full" onclick="app.addWater(1)">+1
                                Glass</button></div>
                    </div>
                </div>
            </div>
        </main>

        <section id="historical-log" class="mt-6">
            <div class="card">
                <div class="flex items-center justify-between mb-4">
                    <h2 class="text-xl font-bold notepad-header">Historical Log</h2>
                    <div class="flex space-x-2 bg-blue-100 p-1 rounded-md">
                        <button id="dailyTabBtn" class="tab-btn active">Daily</button>
                        <button id="weeklyTabBtn" class="tab-btn">Weekly</button>
                    </div>
                </div>
                <div id="dailyTabView" class="tab-content active">
                    <div class="flex items-center space-x-4 mb-4">
                        <label for="date-picker">Select a date:</label>
                        <input type="date" id="date-picker" class="px-3 py-1">
                    </div>
                    <div id="daily-log-content">
                        <p class="text-center text-blue-400">Select a date to view its log.</p>
                    </div>
                </div>
                <div id="weeklyTabView" class="tab-content">
                    <div id="weekly-log-content"></div>
                </div>
            </div>
        </section>
    </div>

    <!-- Timer Modal -->
    <div id="timerModal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center hidden z-50">
        <div class="bg-white rounded-lg p-8 text-center w-80 transform transition-all border-4 border-blue-800"
            style="transform: scale(0.95); opacity: 0;">
            <h2 id="timerExerciseName" class="text-2xl font-bold mb-4 text-blue-900">Plank</h2>
            <div id="timerDisplay" class="text-8xl font-bold text-blue-800 my-8">60</div>
            <div class="flex justify-center space-x-4">
                <button id="timerControlBtn" class="btn btn-primary w-32 text-lg">Start</button>
                <button id="timerResetBtn" class="btn btn-secondary w-32 text-lg">Reset</button>
            </div>
            <button id="timerDoneBtn" class="btn btn-secondary w-full mt-6">Done</button>
        </div>
    </div>


    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, getDoc, collection, query, where, getDocs } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appUI = {
            loadingContainer: document.getElementById('loading-container'),
            landingPageContainer: document.getElementById('landing-page-container'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logoutBtn'),
            googleSignUpBtn: document.getElementById('googleSignUpBtn'),
            googleSignInBtn: document.getElementById('googleSignInBtn'),
            authError: document.getElementById('auth-error'),
            workoutSelector: document.getElementById('workoutSelector'),
            workoutStack: document.getElementById('workoutStack'),
            liquidCaloriesDisplay: document.getElementById('liquidCaloriesDisplay'),
            liquidCaloriesBar: document.getElementById('liquidCaloriesBar'),
            waterIntakeDisplay: document.getElementById('waterIntakeDisplay'),
            waterIntakeBar: document.getElementById('waterIntakeBar'),
            workoutStreakDisplay: document.getElementById('workoutStreakDisplay'),
            lastWorkoutDate: document.getElementById('lastWorkoutDate'),
            excessCaloriesDisplay: document.getElementById('excessCaloriesDisplay'),
            excessList: document.getElementById('excessList'),
            dailyTabBtn: document.getElementById('dailyTabBtn'),
            weeklyTabBtn: document.getElementById('weeklyTabBtn'),
            dailyTabView: document.getElementById('dailyTabView'),
            weeklyTabView: document.getElementById('weeklyTabView'),
            datePicker: document.getElementById('date-picker'),
            dailyLogContent: document.getElementById('daily-log-content'),
            weeklyLogContent: document.getElementById('weekly-log-content'),
            timerModal: document.getElementById('timerModal'), timerExerciseName: document.getElementById('timerExerciseName'), timerDisplay: document.getElementById('timerDisplay'), timerControlBtn: document.getElementById('timerControlBtn'), timerResetBtn: document.getElementById('timerResetBtn'), timerDoneBtn: document.getElementById('timerDoneBtn'),
            // Meal UI references
            breakfastList: document.getElementById('breakfastList'),
            lunchList: document.getElementById('lunchList'),
            dinnerList: document.getElementById('dinnerList'),
            snacksList: document.getElementById('snacksList'),
            breakfastSection: document.getElementById('breakfastSection'),
            lunchSection: document.getElementById('lunchSection'),
            dinnerSection: document.getElementById('dinnerSection'),
            snacksSection: document.getElementById('snacksSection'),
            // Macro UI references
            proteinDisplay: document.getElementById('proteinDisplay'),
            carbsDisplay: document.getElementById('carbsDisplay'),
            fatDisplay: document.getElementById('fatDisplay'),
            totalCaloriesDisplay: document.getElementById('totalCaloriesDisplay'),
            proteinBar: document.getElementById('proteinBar'),
            carbsBar: document.getElementById('carbsBar'),
            fatBar: document.getElementById('fatBar'),
        };

        const app = {
            db: null, auth: null, userId: null, unsubscribe: null, userProfileUnsubscribe: null, todayState: {}, userProfile: {},
            timerInterval: null, timerSecondsLeft: 0, timerOriginalSeconds: 0, isTimerRunning: false, currentTimerExercise: null,
            workouts: { home_abs: { name: 'Home Ab Workout', duration: '15 Mins', exercises: [{ name: 'Push Ups', sets: 3, reps: '10-15' }, { name: 'Crunches', sets: 3, reps: 20 }, { name: 'Leg Raises', sets: 3, reps: 15 }, { name: 'Plank', sets: 3, reps: '60s hold' }, { name: 'Russian Twists', sets: 3, reps: '20 (each side)' },] }, gym_push: { name: 'Gym: Push Day', duration: '45 Mins', exercises: [{ name: 'Bench Press', sets: 3, reps: '8-12' }, { name: 'Overhead Press', sets: 3, reps: '8-12' }, { name: 'Incline DB Press', sets: 3, reps: '10-15' }, { name: 'Tricep Pushdowns', sets: 3, reps: '12-15' }, { name: 'Lateral Raises', sets: 4, reps: '12-15' },] }, gym_pull: { name: 'Gym: Pull Day', duration: '45 Mins', exercises: [{ name: 'Pull-Ups / Lat Pulldowns', sets: 3, reps: '8-12' }, { name: 'Bent-Over Rows', sets: 3, reps: '8-12' }, { name: 'Face Pulls', sets: 3, reps: '15-20' }, { name: 'Bicep Curls', sets: 3, reps: '12-15' },] }, gym_legs: { name: 'Gym: Legs Day', duration: '45 Mins', exercises: [{ name: 'Squats', sets: 3, reps: '8-12' }, { name: 'Romanian Deadlifts', sets: 3, reps: '10-12' }, { name: 'Leg Press', sets: 3, reps: '12-15' }, { name: 'Leg Curls', sets: 3, reps: '12-15' }, { name: 'Calf Raises', sets: 4, reps: '15-20' },] }, cardio: { name: 'Cardio' }, rest_day: { name: 'Rest Day' }, },

            async init() {
                const firebaseConfig = { apiKey: "AIzaSyC8Z5uv-7AiSEStw0jBYGvlsmVo9Ly63J4", authDomain: "health-dashboard-c880e.firebaseapp.com", projectId: "health-dashboard-c880e", storageBucket: "health-dashboard-c880e.appspot.com", messagingSenderId: "108872105823", appId: "1:108872105823:web:5a64271ad63cf76b83c0ea" };
                if (!firebaseConfig.apiKey) { appUI.landingPageContainer.innerHTML = '<p class="text-red-400 text-center">Firebase config missing.</p>'; return; }
                const firebaseApp = initializeApp(firebaseConfig);
                this.auth = getAuth(firebaseApp);
                this.db = getFirestore(firebaseApp);

                console.log('[DEBUG] init: Setting Firebase Auth persistence to LOCAL');
                // CRITICAL FIX: Set persistence to LOCAL to maintain auth state across redirects
                try {
                    const { browserLocalPersistence, setPersistence } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
                    await setPersistence(this.auth, browserLocalPersistence);
                    console.log('[DEBUG] init: Persistence set successfully');
                } catch (error) {
                    console.error('[DEBUG] init: Failed to set persistence:', error);
                }

                this.addEventListeners();

                // Initialize meal tab to breakfast
                this.selectMealType('breakfast');

                this.resolveAuthState();
            },

            async resolveAuthState() {
                console.log('[DEBUG] resolveAuthState: Starting auth resolution');
                // Since we're using popup auth, we just need to set up the auth state listener
                // No need to check for redirect results
                console.log('[DEBUG] resolveAuthState: Setting up auth state listener');
                onAuthStateChanged(this.auth, user => {
                    console.log('[DEBUG] onAuthStateChanged: Fired with user:', user ? user.uid : 'null');
                    if (user) {
                        this.setupUIForUser(user);
                    } else {
                        this.setupUIForGuest();
                    }
                });
            },

            setupUIForUser(user) {
                console.log('[DEBUG] setupUIForUser: Called for user', user.uid);
                console.log('[DEBUG] setupUIForUser: Current userId was', this.userId);

                if (this.userId === user.uid) {
                    console.warn('[DEBUG] setupUIForUser: Already set up for this user, skipping duplicate setup');
                    return;
                }

                this.userId = user.uid;
                const welcomeMessage = document.getElementById('welcomeMessage');
                if (user.displayName) {
                    welcomeMessage.textContent = `Welcome back, ${user.displayName.split(' ')[0]}!`;
                    // Update profile button with user's initial
                    const profileBtn = document.getElementById('profileBtn');
                    if (profileBtn) {
                        profileBtn.textContent = user.displayName.charAt(0).toUpperCase();
                    }
                }
                console.log('[DEBUG] setupUIForUser: Showing app container, hiding others');
                appUI.loadingContainer.classList.add('hidden');
                appUI.landingPageContainer.classList.add('hidden');
                appUI.appContainer.classList.remove('hidden');
                console.log('[DEBUG] setupUIForUser: Setting up realtime listeners');
                this.setupRealtimeListeners();
            },

            setupUIForGuest() {
                console.log('[DEBUG] setupUIForGuest: Showing landing page');
                this.userId = null;
                appUI.loadingContainer.classList.add('hidden');
                appUI.landingPageContainer.classList.remove('hidden');
                appUI.appContainer.classList.add('hidden');
                appUI.authError.textContent = '';  // Clear any previous errors
                if (this.unsubscribe) this.unsubscribe();
                if (this.userProfileUnsubscribe) this.userProfileUnsubscribe();
            },

            async signInWithGoogle() {
                console.log('[DEBUG] signInWithGoogle: Starting Google sign-in popup');
                const provider = new GoogleAuthProvider();
                try {
                    appUI.authError.textContent = '';  // Clear previous errors
                    console.log('[DEBUG] signInWithGoogle: Opening popup...');
                    const result = await signInWithPopup(this.auth, provider);
                    console.log('[DEBUG] signInWithGoogle: Sign-in successful, user:', result.user.uid);
                    // onAuthStateChanged will handle the UI update automatically
                } catch (error) {
                    console.error("[DEBUG] Google Sign-In Popup Error:", error);
                    console.error("[DEBUG] Error details:", error.code, error.message);

                    // Provide user-friendly error messages
                    if (error.code === 'auth/popup-closed-by-user') {
                        appUI.authError.textContent = 'Sign-in cancelled. Please try again.';
                    } else if (error.code === 'auth/popup-blocked') {
                        appUI.authError.textContent = 'Popup blocked by browser. Please allow popups for this site.';
                    } else {
                        appUI.authError.textContent = `Error during sign-in: ${error.message}`;
                    }
                }
            },

            setupRealtimeListeners() {
                if (this.unsubscribe) this.unsubscribe(); if (this.userProfileUnsubscribe) this.userProfileUnsubscribe();
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const today = this.getTodayDateString();
                const todayDocRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'dailyLogs', today);
                this.unsubscribe = onSnapshot(todayDocRef, (docSnap) => { this.todayState = docSnap.exists() ? docSnap.data() : this.getInitialDailyState(); this.renderTodaysData(); });
                const userProfileRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'userProfile');
                this.userProfileUnsubscribe = onSnapshot(userProfileRef, (docSnap) => {
                    this.userProfile = docSnap.exists() ? docSnap.data() : this.getInitialUserProfile();
                    this.renderUserProfile();
                    // Check if onboarding is needed
                    this.onboarding.init();
                });

                // Load user's custom workouts
                this.workoutBuilder.loadUserWorkouts();
            },

            async saveData(dataType) {
                if (!this.userId) return; const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                try {
                    if (dataType === 'daily') { const today = this.getTodayDateString(); const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'dailyLogs', today); await setDoc(docRef, this.todayState, { merge: true }); }
                    else if (dataType === 'profile') { const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'userProfile'); await setDoc(docRef, this.userProfile, { merge: true }); }
                } catch (error) { console.error(`Error saving ${dataType} data:`, error); }
            },

            getInitialDailyState() { return { liquidCalories: 0, waterIntake: 0, excessCalories: 0, excessLog: [], todaysWorkouts: [] }; },
            getInitialUserProfile() {
                return {
                    workoutStreak: 0,
                    lastWorkoutDate: '',
                    onboardingCompleted: false,
                    primaryGoal: null,
                    waterGoal: 8,
                    liquidCaloriesGoal: 500,
                    weeklyWorkoutGoal: 3,
                    createdAt: null
                };
            },
            getTodayDateString() { return new Date().toISOString().split('T')[0]; },

            addWorkout(workoutId) {
                if (workoutId === 'none') return;
                const workoutData = this.workouts[workoutId];
                if (!workoutData) return;
                if (!Array.isArray(this.todayState.todaysWorkouts)) this.todayState.todaysWorkouts = [];
                const newWorkout = { id: workoutId, instanceId: `workout_${Date.now()}`, name: workoutData.name, isComplete: false };
                if (workoutId === 'cardio') { newWorkout.cardioType = 'Running'; newWorkout.duration = 30; }
                else if (workoutId !== 'rest_day') { newWorkout.completedExercises = []; }
                this.todayState.todaysWorkouts.push(newWorkout);
                this.saveData('daily');
                appUI.workoutSelector.value = 'none';
            },

            removeWorkout(instanceId) { this.todayState.todaysWorkouts = this.todayState.todaysWorkouts.filter(w => w.instanceId !== instanceId); this.saveData('daily'); },
            updateCardioDetails(instanceId, field, value) { const workout = this.todayState.todaysWorkouts.find(w => w.instanceId === instanceId); if (!workout) return; if (field === 'duration') { workout[field] = parseInt(value, 10) || 0; } else { workout[field] = value; } this.saveData('daily'); },

            toggleExercise(instanceId, exerciseName, forceCheck = false) {
                const workout = this.todayState.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout) return;
                if (!workout.completedExercises) workout.completedExercises = [];
                const index = workout.completedExercises.indexOf(exerciseName);
                if (forceCheck) {
                    if (index === -1) workout.completedExercises.push(exerciseName);
                } else {
                    if (index > -1) workout.completedExercises.splice(index, 1);
                    else workout.completedExercises.push(exerciseName);
                }
                this.saveData('daily');
            },

            completeWorkout(instanceId) {
                const workout = this.todayState.todaysWorkouts.find(w => w.instanceId === instanceId); if (!workout || workout.isComplete) return;
                workout.isComplete = true;

                // 🎉 CELEBRATION! Show confetti animation
                if (typeof confetti !== 'undefined') {
                    confetti({
                        particleCount: 100,
                        spread: 70,
                        origin: { y: 0.6 },
                        colors: ['#1E3A8A', '#60A5FA', '#93C5FD', '#FEF9C3', '#BFDBFE']
                    });
                }

                const isFirstCompletionToday = !this.todayState.todaysWorkouts.some(w => w.isComplete && w.instanceId !== instanceId);
                if (isFirstCompletionToday) {
                    const today = this.getTodayDateString(); const lastWorkout = this.userProfile.lastWorkoutDate;
                    if (!lastWorkout || lastWorkout !== today) {
                        const yesterday = new Date(); yesterday.setDate(yesterday.getDate() - 1);
                        const lastWorkoutDateObj = lastWorkout ? new Date(lastWorkout + 'T00:00:00') : null;
                        if (lastWorkoutDateObj && lastWorkoutDateObj.toDateString() === yesterday.toDateString()) { this.userProfile.workoutStreak = (this.userProfile.workoutStreak || 0) + 1; }
                        else { this.userProfile.workoutStreak = 1; }
                    }
                    this.userProfile.lastWorkoutDate = today; this.saveData('profile');
                }
                this.saveData('daily');
            },

            addLiquidCalories(calories) { this.todayState.liquidCalories = (this.todayState.liquidCalories || 0) + calories; this.saveData('daily'); },
            addWater(glasses) { this.todayState.waterIntake = (this.todayState.waterIntake || 0) + glasses; this.saveData('daily'); },

            // Meal selection and logging
            currentMealType: 'breakfast',

            selectMealType(mealType) {
                this.currentMealType = mealType;
                // Update button active states
                ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(type => {
                    const btn = document.getElementById(`${type}TabBtn`);
                    const section = document.getElementById(`${type}Section`);
                    if (type === mealType) {
                        btn?.classList.add('active');
                        section?.classList.remove('hidden');
                    } else {
                        btn?.classList.remove('active');
                        section?.classList.add('hidden');
                    }
                });
            },

            async addMealWithAI() {
                const descInput = document.getElementById('foodDescInput');
                const desc = descInput.value.trim();
                if (!desc) return;

                const logBtn = document.getElementById('logFoodBtn');
                const logText = document.getElementById('logFoodText');
                const logSpinner = document.getElementById('logFoodSpinner');
                logBtn.disabled = true;
                logText.textContent = 'Calculating...';
                logSpinner.classList.remove('hidden');

                try {
                    const apiKey = "AIzaSyD6imNqPY8RfloxyOxxbYz_pvYScIxmkvk";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;

                    // Enhanced prompt to request macronutrient breakdown
                    const payload = {
                        contents: [{
                            parts: [{
                                text: `Estimate the nutritional content for: ${desc}. Provide calories, protein (in grams), carbohydrates (in grams), and fat (in grams).`
                            }]
                        }],
                        generationConfig: {
                            responseMimeType: "application/json",
                            responseSchema: {
                                type: "OBJECT",
                                properties: {
                                    calories: { type: "NUMBER" },
                                    protein: { type: "NUMBER" },
                                    carbs: { type: "NUMBER" },
                                    fat: { type: "NUMBER" }
                                },
                                required: ["calories", "protein", "carbs", "fat"]
                            }
                        }
                    };

                    const response = await fetch(apiUrl, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });

                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);

                    const result = await response.json();
                    const nutrition = JSON.parse(result.candidates[0].content.parts[0].text);

                    if (nutrition.calories > 0) {
                        // Initialize meals structure if needed
                        if (!this.todayState.meals) {
                            this.todayState.meals = {
                                breakfast: [],
                                lunch: [],
                                dinner: [],
                                snacks: []
                            };
                        }

                        // Add meal to the selected category
                        const mealEntry = {
                            desc: desc,
                            calories: nutrition.calories,
                            protein: nutrition.protein,
                            carbs: nutrition.carbs,
                            fat: nutrition.fat,
                            timestamp: Date.now()
                        };

                        this.todayState.meals[this.currentMealType].push(mealEntry);

                        // Clear input and save
                        descInput.value = '';
                        this.saveData('daily');

                        // Update UI
                        this.renderMeals();
                        this.renderMacros();
                    } else {
                        throw new Error("Could not estimate nutrition.");
                    }
                } catch (error) {
                    console.error("Nutrition estimation failed:", error);
                    alert("Sorry, I couldn't estimate the nutrition for this food.");
                }
                finally {
                    logBtn.disabled = false;
                    logText.textContent = 'Calculate & Log';
                    logSpinner.classList.add('hidden');
                }
            },
            // Render logged meals by category
            renderMeals() {
                const state = this.todayState;
                if (!state || !state.meals) return;

                // Render each meal category
                ['breakfast', 'lunch', 'dinner', 'snacks'].forEach(mealType => {
                    const listEl = appUI[`${mealType}List`];
                    const sectionEl = appUI[`${mealType}Section`];
                    const meals = state.meals[mealType] || [];

                    if (meals.length > 0) {
                        // Show section if it has meals
                        sectionEl.classList.remove('hidden');

                        // Render meal items
                        listEl.innerHTML = meals.map((meal, index) => `
                            <div class="flex justify-between items-start bg-yellow-50 p-3 rounded-md hover:bg-yellow-100">
                                <div class="flex-grow">
                                    <p class="font-semibold text-blue-900">${meal.desc}</p>
                                    <p class="text-xs text-blue-600 mt-1">
                                        ${meal.calories} cal • 
                                        P: ${meal.protein}g • 
                                        C: ${meal.carbs}g • 
                                        F: ${meal.fat}g
                                    </p>
                                </div>
                                <button 
                                    onclick="app.deleteMeal('${mealType}', ${index})" 
                                    class="text-red-500 hover:text-red-700 ml-3 text-sm font-bold"
                                    title="Delete meal">
                                    ×
                                </button>
                            </div>
                        `).join('');
                    } else {
                        // Hide section if empty
                        sectionEl.classList.add('hidden');
                    }
                });
            },

            // Calculate and render macro progress
            renderMacros() {
                const state = this.todayState;
                if (!state || !state.meals) {
                    // Reset displays if no data
                    appUI.proteinDisplay.textContent = '0';
                    appUI.carbsDisplay.textContent = '0';
                    appUI.fatDisplay.textContent = '0';
                    appUI.totalCaloriesDisplay.textContent = '0';
                    appUI.proteinBar.style.width = '0%';
                    appUI.carbsBar.style.width = '0%';
                    appUI.fatBar.style.width = '0%';
                    return;
                }

                // Calculate totals across all meals
                let totalProtein = 0;
                let totalCarbs = 0;
                let totalFat = 0;
                let totalCalories = 0;

                Object.values(state.meals).forEach(mealCategory => {
                    mealCategory.forEach(meal => {
                        totalProtein += meal.protein || 0;
                        totalCarbs += meal.carbs || 0;
                        totalFat += meal.fat || 0;
                        totalCalories += meal.calories || 0;
                    });
                });

                // Default goals (can be customized later)
                const proteinGoal = 150;
                const carbsGoal = 200;
                const fatGoal = 65;

                // Update displays
                appUI.proteinDisplay.textContent = Math.round(totalProtein);
                appUI.carbsDisplay.textContent = Math.round(totalCarbs);
                appUI.fatDisplay.textContent = Math.round(totalFat);
                appUI.totalCaloriesDisplay.textContent = Math.round(totalCalories);

                // Update progress bars
                const proteinPercent = (totalProtein / proteinGoal) * 100;
                const carbsPercent = (totalCarbs / carbsGoal) * 100;
                const fatPercent = (totalFat / fatGoal) * 100;

                appUI.proteinBar.style.width = `${Math.min(100, proteinPercent)}%`;
                appUI.carbsBar.style.width = `${Math.min(100, carbsPercent)}%`;
                appUI.fatBar.style.width = `${Math.min(100, fatPercent)}%`;

                // Add goal-reached animation
                if (proteinPercent >= 100) {
                    appUI.proteinBar.classList.add('goal-reached');
                } else {
                    appUI.proteinBar.classList.remove('goal-reached');
                }

                if (carbsPercent >= 100) {
                    appUI.carbsBar.classList.add('goal-reached');
                } else {
                    appUI.carbsBar.classList.remove('goal-reached');
                }

                if (fatPercent >= 100) {
                    appUI.fatBar.classList.add('goal-reached');
                } else {
                    appUI.fatBar.classList.remove('goal-reached');
                }
            },

            // Delete a meal from a specific category
            deleteMeal(mealType, index) {
                if (!this.todayState.meals || !this.todayState.meals[mealType]) return;

                // Remove the meal at the specified index
                this.todayState.meals[mealType].splice(index, 1);

                // Re-render meals and macros
                this.renderMeals();
                this.renderMacros();

                // Save to Firestore
                this.saveData('daily');
            },


            renderTodaysData() {
                const state = this.todayState; if (!state) return;
                appUI.workoutStack.innerHTML = '';
                if (state.todaysWorkouts && state.todaysWorkouts.length > 0) {
                    state.todaysWorkouts.forEach(workout => {
                        let contentHtml = '';
                        if (workout.id === 'rest_day') { contentHtml = `<p class="text-center text-blue-500 p-4">Take a day to recover and recharge.</p>`; }
                        else if (workout.id === 'cardio') { contentHtml = `<div class="space-y-4 p-2"><div><label class="block text-sm font-semibold text-blue-800 mb-1">Cardio Type</label><select class="w-full px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'cardioType', this.value)"><option ${workout.cardioType === 'Running' ? 'selected' : ''}>Running</option><option ${workout.cardioType === 'Cycling' ? 'selected' : ''}>Cycling</option><option ${workout.cardioType === 'Swimming' ? 'selected' : ''}>Swimming</option><option ${workout.cardioType === 'Elliptical' ? 'selected' : ''}>Elliptical</option><option ${workout.cardioType === 'Rowing' ? 'selected' : ''}>Rowing</option><option ${workout.cardioType === 'Stair Climber' ? 'selected' : ''}>Stair Climber</option></select></div><div><label class="block text-sm font-semibold text-blue-800 mb-1">Duration (minutes)</label><input type="number" value="${workout.duration}" class="w-full px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'duration', this.value)"></div></div>`; }
                        else {
                            const workoutData = this.workouts[workout.id];
                            if (!workoutData || !workoutData.exercises) {
                                console.error(`[DEBUG] Missing workout data or exercises for workout.id: ${workout.id}`);
                                contentHtml = `<p class="text-center text-red-500 p-4">Error: Workout data not found</p>`;
                            } else {
                                contentHtml = `<div class="space-y-3">${workoutData.exercises.map(ex => {
                                    const isChecked = (workout.completedExercises || []).includes(ex.name);
                                    const repsStr = String(ex.reps || '');
                                    const isTimeBased = repsStr.includes('s') || repsStr.includes('hold');
                                    let actionHtml = '';
                                    if (isTimeBased) {
                                        const seconds = parseInt(repsStr) || 0;
                                        actionHtml = `<button class="btn btn-secondary btn-sm py-1 px-2 text-xs ml-4" onclick="app.startTimer('${workout.instanceId}', '${ex.name}', ${seconds})">Timer</button>`;
                                    }
                                    return `<div class="flex items-center p-3 bg-yellow-50 rounded-md hover:bg-yellow-100"><label class="flex items-center flex-grow cursor-pointer"><input type="checkbox" class="h-5 w-5 rounded mr-4" onchange="app.toggleExercise('${workout.instanceId}', '${ex.name}')" ${isChecked ? 'checked' : ''}><span class="notepad-text">${ex.name}</span></label><span class="text-blue-500 text-sm whitespace-nowrap">${ex.sets} x ${ex.reps}</span>${actionHtml}</div>`;
                                }).join('')}</div>`;
                            }
                        }
                        appUI.workoutStack.innerHTML += `<div class="border-2 border-blue-800 rounded-md p-4"><div class="flex justify-between items-center mb-4"><h3 class="font-bold text-lg notepad-header">${workout.name}</h3><button class="btn btn-danger btn-sm py-1 px-2 text-xs" onclick="app.removeWorkout('${workout.instanceId}')">Remove</button></div>${contentHtml}<button class="btn btn-primary mt-6 w-full" onclick="app.completeWorkout('${workout.instanceId}')" ${workout.isComplete ? 'disabled' : ''}>${workout.isComplete ? 'Completed!' : 'Mark as Complete'}</button></div>`;
                    });
                } else { appUI.workoutStack.innerHTML = `<p class="text-center text-blue-500 py-4">No workouts added for today.</p>`; }

                appUI.liquidCaloriesDisplay.textContent = state.liquidCalories || 0;
                const liquidCalPercent = ((state.liquidCalories || 0) / 500) * 100;
                appUI.liquidCaloriesBar.style.width = `${Math.min(100, liquidCalPercent)}%`;
                // Add goal-reached class if at or over 100%
                if (liquidCalPercent >= 100) {
                    appUI.liquidCaloriesBar.classList.add('goal-reached');
                } else {
                    appUI.liquidCaloriesBar.classList.remove('goal-reached');
                }

                appUI.waterIntakeDisplay.textContent = state.waterIntake || 0;
                const waterPercent = ((state.waterIntake || 0) / 8) * 100;
                appUI.waterIntakeBar.style.width = `${Math.min(100, waterPercent)}%`;
                // Add goal-reached class if at or over 100%
                if (waterPercent >= 100) {
                    appUI.waterIntakeBar.classList.add('goal-reached');
                } else {
                    appUI.waterIntakeBar.classList.remove('goal-reached');
                }
                appUI.excessCaloriesDisplay.textContent = state.excessCalories || 0;
                appUI.excessList.innerHTML = (state.excessLog || []).map(item => `<div class="flex justify-between items-center bg-yellow-50 p-2 rounded-md"><span>${item.desc}</span><span class="font-semibold text-blue-800">${item.calories} kcal</span></div>`).join('');

                // Render meals and macros
                this.renderMeals();
                this.renderMacros();
            },
            renderUserProfile() {
                const profile = this.userProfile; if (!profile) return;
                appUI.workoutStreakDisplay.textContent = profile.workoutStreak || 0;
                appUI.lastWorkoutDate.textContent = profile.lastWorkoutDate ? `Last workout: ${new Date(profile.lastWorkoutDate + 'T00:00:00').toLocaleDateString()}` : 'No workouts yet.';
            },

            // --- TIMER LOGIC ---
            startTimer(instanceId, exerciseName, seconds) {
                this.currentTimerExercise = { instanceId, exerciseName };
                this.timerOriginalSeconds = seconds;
                this.timerSecondsLeft = seconds;
                this.isTimerRunning = false;
                appUI.timerExerciseName.textContent = exerciseName;
                this.updateTimerDisplay();
                appUI.timerControlBtn.textContent = 'Start';
                appUI.timerModal.classList.remove('hidden');
                setTimeout(() => {
                    const modalContent = appUI.timerModal.firstElementChild;
                    modalContent.style.opacity = 1;
                    modalContent.style.transform = 'scale(1)';
                }, 10);
            },
            controlTimer() {
                this.isTimerRunning = !this.isTimerRunning;
                if (this.isTimerRunning) {
                    appUI.timerControlBtn.textContent = 'Pause';
                    this.timerInterval = setInterval(() => this.tick(), 1000);
                } else {
                    appUI.timerControlBtn.textContent = 'Resume';
                    clearInterval(this.timerInterval);
                }
            },
            resetTimer() {
                clearInterval(this.timerInterval);
                this.isTimerRunning = false;
                this.timerSecondsLeft = this.timerOriginalSeconds;
                this.updateTimerDisplay();
                appUI.timerControlBtn.textContent = 'Start';
            },
            tick() {
                this.timerSecondsLeft--;
                this.updateTimerDisplay();
                if (this.timerSecondsLeft <= 0) {
                    clearInterval(this.timerInterval);
                    this.isTimerRunning = false;
                    this.playTimerSound();
                    this.toggleExercise(this.currentTimerExercise.instanceId, this.currentTimerExercise.exerciseName, true);
                    appUI.timerControlBtn.textContent = 'Done!';
                    appUI.timerControlBtn.disabled = true;
                    setTimeout(() => { this.closeTimer(); appUI.timerControlBtn.disabled = false; }, 1500);
                }
            },
            closeTimer() {
                clearInterval(this.timerInterval);
                const modalContent = appUI.timerModal.firstElementChild;
                modalContent.style.transform = 'scale(0.95)';
                modalContent.style.opacity = 0;
                setTimeout(() => appUI.timerModal.classList.add('hidden'), 200);
            },
            updateTimerDisplay() {
                appUI.timerDisplay.textContent = this.timerSecondsLeft;
            },
            playTimerSound() {
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                oscillator.type = 'sine';
                oscillator.frequency.setValueAtTime(880, audioContext.currentTime); // A5 note
                gainNode.gain.setValueAtTime(0.5, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.0001, audioContext.currentTime + 1);
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 1);
            },

            // --- ONBOARDING LOGIC ---
            onboarding: {
                currentStep: 1,
                selectedGoal: null,

                init() {
                    // Check if user has completed onboarding
                    if (!app.userProfile.onboardingCompleted) {
                        document.getElementById('onboarding-modal').classList.remove('hidden');
                    }
                },

                nextStep() {
                    document.getElementById(`onboarding-step-${this.currentStep}`).classList.add('hidden');
                    this.currentStep++;
                    document.getElementById(`onboarding-step-${this.currentStep}`).classList.remove('hidden');
                },

                selectGoal(goal) {
                    this.selectedGoal = goal;
                    this.nextStep();
                },

                async complete() {
                    // Get values from inputs
                    const waterGoal = parseInt(document.getElementById('onboarding-water-goal').value);
                    const liquidCaloriesGoal = parseInt(document.getElementById('onboarding-liquid-goal').value);
                    const weeklyWorkoutGoal = parseInt(document.getElementById('onboarding-workout-days').value);

                    // Update user profile
                    app.userProfile.onboardingCompleted = true;
                    app.userProfile.primaryGoal = this.selectedGoal;
                    app.userProfile.waterGoal = waterGoal;
                    app.userProfile.liquidCaloriesGoal = liquidCaloriesGoal;
                    app.userProfile.weeklyWorkoutGoal = weeklyWorkoutGoal;
                    app.userProfile.createdAt = new Date().toISOString();

                    // Save to Firestore
                    await app.saveData('profile');

                    // Close modal with animation
                    document.getElementById('onboarding-modal').classList.add('hidden');

                    // Reset for next time (if needed)
                    this.currentStep = 1;
                    this.selectedGoal = null;

                    // Show celebration
                    if (typeof confetti !== 'undefined') {
                        confetti({
                            particleCount: 150,
                            spread: 100,
                            origin: { y: 0.6 },
                            colors: ['#1E3A8A', '#60A5FA', '#93C5FD', '#FEF9C3', '#BFDBFE']
                        });
                    }
                }
            },

            // --- WORKOUT BUILDER LOGIC ---
            workoutBuilder: {
                currentWorkout: null,
                isEditing: false,

                open(workoutId = null) {
                    this.isEditing = !!workoutId;
                    if (workoutId) {
                        // Load existing workout for editing
                        this.loadWorkout(workoutId);
                    } else {
                        // New workout
                        this.currentWorkout = null;
                        document.getElementById('custom-workout-name').value = '';
                        document.getElementById('custom-workout-duration').value = '45';
                        document.getElementById('custom-exercises-list').innerHTML = '';
                        // Add one exercise by default
                        this.addExercise();
                    }
                    document.getElementById('workout-builder-modal').classList.remove('hidden');
                },

                close() {
                    document.getElementById('workout-builder-modal').classList.add('hidden');
                },

                addExercise() {
                    const template = document.getElementById('exercise-item-template');
                    const clone = template.content.cloneNode(true);
                    document.getElementById('custom-exercises-list').appendChild(clone);
                },

                removeExercise(button) {
                    button.closest('.exercise-item').remove();
                },

                async loadWorkout(workoutId) {
                    const workout = app.workouts[workoutId];
                    if (!workout) return;

                    this.currentWorkout = workout;
                    document.getElementById('custom-workout-name').value = workout.name;
                    document.getElementById('custom-workout-duration').value = workout.duration;

                    // Clear and populate exercises
                    document.getElementById('custom-exercises-list').innerHTML = '';
                    workout.exercises.forEach(ex => {
                        this.addExercise();
                        const items = document.querySelectorAll('.exercise-item');
                        const lastItem = items[items.length - 1];
                        lastItem.querySelector('.exercise-name').value = ex.name;
                        lastItem.querySelector('.exercise-sets').value = ex.sets;
                        lastItem.querySelector('.exercise-reps').value = ex.reps;
                        lastItem.querySelector('.exercise-rest').value = ex.restTime || 90;
                    });
                },

                async save() {
                    const name = document.getElementById('custom-workout-name').value.trim();
                    if (!name) {
                        alert('Please enter a workout name');
                        return;
                    }

                    const exercises = [];
                    document.querySelectorAll('.exercise-item').forEach(item => {
                        const exerciseName = item.querySelector('.exercise-name').value.trim();
                        if (exerciseName) {
                            exercises.push({
                                name: exerciseName,
                                sets: parseInt(item.querySelector('.exercise-sets').value),
                                reps: item.querySelector('.exercise-reps').value.trim(),
                                restTime: parseInt(item.querySelector('.exercise-rest').value)
                            });
                        }
                    });

                    if (exercises.length === 0) {
                        alert('Please add at least one exercise');
                        return;
                    }

                    const workoutId = this.currentWorkout?.id || `custom_${Date.now()}`;
                    const workoutData = {
                        id: workoutId,
                        name: name,
                        duration: parseInt(document.getElementById('custom-workout-duration').value),
                        exercises: exercises,
                        lastModified: new Date().toISOString()
                    };

                    if (!this.isEditing) {
                        workoutData.createdAt = new Date().toISOString();
                    }

                    // Save to Firestore
                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const docRef = doc(app.db, 'artifacts', appId, 'users', app.userId, 'customWorkouts', workoutId);
                        await setDoc(docRef, workoutData);

                        // Add to local workouts object
                        app.workouts[workoutId] = workoutData;

                        // Update workout selector
                        this.updateWorkoutSelector();

                        this.close();

                        // Show success message
                        if (typeof confetti !== 'undefined') {
                            confetti({
                                particleCount: 50,
                                spread: 60,
                                origin: { y: 0.6 },
                                colors: ['#1E3A8A', '#60A5FA', '#93C5FD']
                            });
                        }

                        alert(`Workout "${name}" ${this.isEditing ? 'updated' : 'created'} successfully! 💪`);
                    } catch (error) {
                        console.error('Error saving workout:', error);
                        alert('Failed to save workout. Please try again.');
                    }
                },

                updateWorkoutSelector() {
                    const selector = document.getElementById('workoutSelector');
                    // Remove old custom options
                    Array.from(selector.options).forEach(option => {
                        if (option.value.startsWith('custom_')) {
                            option.remove();
                        }
                    });

                    // Add custom workouts before 'cardio' option
                    const cardioOption = selector.querySelector('[value="cardio"]');
                    Object.keys(app.workouts).forEach(workoutId => {
                        if (workoutId.startsWith('custom_')) {
                            const workout = app.workouts[workoutId];
                            const option = document.createElement('option');
                            option.value = workoutId;
                            option.textContent = `${workout.name} (${workout.duration} Mins) [Custom]`;
                            selector.insertBefore(option, cardioOption);
                        }
                    });
                },

                async loadUserWorkouts() {
                    if (!app.userId) return;

                    try {
                        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                        const workoutsRef = collection(app.db, 'artifacts', appId, 'users', app.userId, 'customWorkouts');
                        const querySnapshot = await getDocs(workoutsRef);

                        querySnapshot.forEach(doc => {
                            app.workouts[doc.id] = doc.data();
                        });

                        this.updateWorkoutSelector();
                    } catch (error) {
                        console.error('Error loading custom workouts:', error);
                    }
                }
            },

            switchTab(tab) {
                appUI.dailyTabView.classList.toggle('active', tab === 'daily');
                appUI.weeklyTabView.classList.toggle('active', tab === 'weekly');
                appUI.dailyTabBtn.classList.toggle('active', tab === 'daily');
                appUI.weeklyTabBtn.classList.toggle('active', tab === 'weekly');
                if (tab === 'weekly') this.fetchWeeklyLog();
            },

            async fetchDailyLog(dateString) {
                if (!dateString || !this.userId) return;
                appUI.dailyLogContent.innerHTML = `<p class="text-center">Loading log for ${dateString}...</p>`;
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'dailyLogs', dateString);
                const docSnap = await getDoc(docRef);
                if (docSnap.exists()) {
                    this.renderDailyLog(docSnap.data());
                } else {
                    appUI.dailyLogContent.innerHTML = `<p class="text-center text-blue-400">No data found for this date.</p>`;
                }
            },

            renderDailyLog(data) {
                const workoutsHtml = (data.todaysWorkouts || []).filter(w => w.isComplete).map(w => `<li>${w.name}</li>`).join('');
                appUI.dailyLogContent.innerHTML = `<div class="space-y-2 text-blue-700"><p><strong>Liquid Calories:</strong> ${data.liquidCalories || 0} kcal</p><p><strong>Water Intake:</strong> ${data.waterIntake || 0} glasses</p><p><strong>Excess Calories:</strong> ${data.excessCalories || 0} kcal</p><p><strong>Workouts Completed:</strong></p><ul class="list-disc list-inside ml-4">${workoutsHtml || '<li>None</li>'}</ul></div>`;
            },

            async fetchWeeklyLog() {
                appUI.weeklyLogContent.innerHTML = `<p class="text-center">Calculating weekly summary...</p>`;
                const today = new Date();
                const dayOfWeek = today.getDay();
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1));
                let dates = [];
                for (let i = 0; i < 7; i++) {
                    const date = new Date(startOfWeek);
                    date.setDate(startOfWeek.getDate() + i);
                    dates.push(date.toISOString().split('T')[0]);
                }
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                const logsRef = collection(this.db, 'artifacts', appId, 'users', this.userId, 'dailyLogs');
                const q = query(logsRef, where('__name__', '>=', dates[0]), where('__name__', '<=', dates[6]));
                const querySnapshot = await getDocs(q);
                let logs = {};
                querySnapshot.forEach(doc => { logs[doc.id] = doc.data(); });
                this.renderWeeklyLog(dates, logs);
            },

            renderWeeklyLog(dates, logs) {
                let totalLiquid = 0, totalExcess = 0, workoutDays = 0;
                const daysHtml = dates.map(dateStr => {
                    const log = logs[dateStr];
                    const dayInitial = new Date(dateStr + 'T00:00:00').toLocaleDateString('en-US', { weekday: 'short' })[0];
                    let hasWorkout = false;
                    if (log) {
                        totalLiquid += log.liquidCalories || 0;
                        totalExcess += log.excessCalories || 0;
                        if (log.todaysWorkouts && log.todaysWorkouts.some(w => w.isComplete)) {
                            hasWorkout = true;
                            workoutDays++;
                        }
                    }
                    return `<div class="text-center"><p class="text-sm text-blue-500">${dayInitial}</p><div class="w-8 h-8 rounded-full flex items-center justify-center mt-1 ${hasWorkout ? 'bg-blue-800 text-white' : 'bg-blue-200'}">${hasWorkout ? '✓' : ''}</div></div>`;
                }).join('');
                const avgLiquid = workoutDays > 0 ? (totalLiquid / workoutDays).toFixed(0) : 0;
                appUI.weeklyLogContent.innerHTML = `<h3 class="font-bold text-lg mb-4 notepad-header">This Week's Summary</h3><div class="flex justify-around mb-6">${daysHtml}</div><div class="space-y-2 text-blue-700"><p><strong>Total Workout Days:</strong> ${workoutDays}</p><p><strong>Average Daily Liquid Calories:</strong> ${avgLiquid} kcal</p><p><strong>Total Weekly Excess Calories:</strong> ${totalExcess} kcal</p></div>`;
            },

            addEventListeners() {
                // Profile dropdown toggle
                const profileBtn = document.getElementById('profileBtn');
                const profileDropdown = document.getElementById('profileDropdown');

                if (profileBtn) {
                    profileBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        profileDropdown.classList.toggle('hidden');
                    });
                }

                // Close dropdown when clicking outside
                document.addEventListener('click', (e) => {
                    if (profileDropdown && !profileDropdown.classList.contains('hidden')) {
                        profileDropdown.classList.add('hidden');
                    }
                });

                appUI.logoutBtn.addEventListener('click', () => {
                    profileDropdown.classList.add('hidden');
                    signOut(this.auth);
                });
                appUI.googleSignUpBtn.addEventListener('click', () => this.signInWithGoogle());
                appUI.googleSignInBtn.addEventListener('click', () => this.signInWithGoogle());
                appUI.workoutSelector.addEventListener('change', (e) => this.addWorkout(e.target.value));
                appUI.dailyTabBtn.addEventListener('click', () => this.switchTab('daily'));
                appUI.weeklyTabBtn.addEventListener('click', () => this.switchTab('weekly'));
                appUI.datePicker.addEventListener('change', (e) => this.fetchDailyLog(e.target.value));
                appUI.datePicker.value = this.getTodayDateString();
                // Timer Listeners
                appUI.timerControlBtn.addEventListener('click', () => this.controlTimer());
                appUI.timerResetBtn.addEventListener('click', () => this.resetTimer());
                appUI.timerDoneBtn.addEventListener('click', () => this.closeTimer());
            }
        };

        app.init();
        window.app = app;
    </script>
</body>

</html>