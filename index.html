<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #030712;
            /* Even darker background */
            color: #E5E7EB;
            /* Light gray text */
        }

        .card {
            background-color: #111827;
            /* Darker card background */
            border: 1px solid #1F2937;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn {
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #14B8A6;
            /* Teal */
            color: white;
        }

        .btn-primary:hover {
            background-color: #0D9488;
        }

        .btn-secondary {
            background-color: #374151;
            /* Darker Gray */
            color: #D1D5DB;
        }

        .btn-secondary:hover {
            background-color: #4B5563;
        }

        .btn-danger {
            background-color: #991B1B;
            /* Dark Red */
            color: white;
        }

        .btn-danger:hover {
            background-color: #7F1D1D;
        }

        .progress-bar {
            background-color: #374151;
            border-radius: 9999px;
            overflow: hidden;
            height: 0.75rem;
            /* Slimmer progress bar */
        }

        .progress-bar-fill {
            background-color: #14B8A6;
            transition: width 0.3s ease-in-out;
        }

        input[type="checkbox"]:checked+span {
            text-decoration: line-through;
            color: #6B7280;
        }

        input[type="checkbox"] {
            accent-color: #14B8A6;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">

    <div id="auth-container">
        <div class="max-w-md mx-auto mt-20 card text-center">
            <h1 class="text-3xl font-bold text-white mb-2">Health Dashboard</h1>
            <p class="text-gray-400 mb-6">Please sign in to continue</p>
            <button id="googleSignInBtn" class="btn btn-primary w-full text-base">
                <svg class="w-5 h-5 mr-3" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 48 48" width="48px"
                    height="48px">
                    <path fill="#FFC107"
                        d="M43.611,20.083H42V20H24v8h11.303c-1.649,4.657-6.08,8-11.303,8c-6.627,0-12-5.373-12-12c0-6.627,5.373-12,12-12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C12.955,4,4,12.955,4,24c0,11.045,8.955,20,20,20c11.045,0,20-8.955,20-20C44,22.659,43.862,21.35,43.611,20.083z" />
                    <path fill="#FF3D00"
                        d="M6.306,14.691l6.571,4.819C14.655,15.108,18.961,12,24,12c3.059,0,5.842,1.154,7.961,3.039l5.657-5.657C34.046,6.053,29.268,4,24,4C16.318,4,9.656,8.337,6.306,14.691z" />
                    <path fill="#4CAF50"
                        d="M24,44c5.166,0,9.86-1.977,13.409-5.192l-6.19-5.238C29.211,35.091,26.715,36,24,36c-5.222,0-9.619-3.317-11.283-7.946l-6.522,5.025C9.505,39.556,16.227,44,24,44z" />
                    <path fill="#1976D2"
                        d="M43.611,20.083H42V20H24v8h11.303c-0.792,2.237-2.231,4.166-4.087,5.574l6.19,5.238C39.99,36.62,44,30.638,44,24C44,22.659,43.862,21.35,43.611,20.083z" />
                </svg>
                Sign in with Google
            </button>
            <div id="auth-error" class="text-red-400 mt-4 text-sm"></div>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
            <div>
                <h1 class="text-3xl font-bold text-white">Your Daily Dashboard</h1>
                <p class="text-gray-400 mt-1">Welcome back! Here's your snapshot for today.</p>
            </div>
            <button id="logoutBtn" class="btn btn-secondary mt-4 sm:mt-0">Logout</button>
        </header>

        <!-- Highlights Bar -->
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-6 mb-6">
            <!-- Workout Streak -->
            <div class="card flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-xl mb-2 text-gray-300">Workout Streak</h2>
                    <p id="lastWorkoutDate" class="text-sm text-gray-500 mt-1">No workouts yet.</p>
                </div>
                <div class="flex items-baseline text-right">
                    <span id="workoutStreakDisplay" class="text-6xl font-bold text-teal-400">0</span>
                    <span class="text-xl font-semibold ml-2 text-gray-400">Days</span>
                </div>
            </div>

            <!-- Total Excess Calories -->
            <div class="card flex items-center justify-between">
                <div>
                    <h2 class="font-bold text-xl mb-2 text-gray-300">Total Excess Calories</h2>
                    <p class="text-sm text-gray-500 mt-1">Logged from snacks & extras.</p>
                </div>
                <div class="flex items-baseline text-right">
                    <span id="excessCaloriesDisplay" class="text-6xl font-bold text-teal-400">0</span>
                    <span class="text-xl font-semibold ml-2 text-gray-400">kcal</span>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-5 gap-6">

            <!-- Left Column (Primary Actions) -->
            <div class="lg:col-span-3 space-y-6">
                <!-- Workouts & AI Logger in one card -->
                <div class="card p-6">
                    <!-- Today's Workout Section -->
                    <div>
                        <h2 class="font-bold text-xl mb-4">Today's Workouts</h2>
                        <div class="mb-4">
                            <select id="workoutSelector"
                                class="w-full bg-gray-800 border border-gray-700 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500">
                                <option value="none">-- Add a workout to your day --</option>
                                <option value="home_abs">Home Ab Workout (15 Mins)</option>
                                <option value="gym_push">Gym: Push Day (45 Mins)</option>
                                <option value="gym_pull">Gym: Pull Day (45 Mins)</option>
                                <option value="gym_legs">Gym: Legs Day (45 Mins)</option>
                                <option value="cardio">Cardio</option>
                                <option value="rest_day">Rest Day</option>
                            </select>
                        </div>
                        <div id="workoutStack" class="space-y-6">
                            <!-- Dynamically added workout blocks will appear here -->
                        </div>
                    </div>

                    <!-- Divider -->
                    <hr class="border-gray-700 my-8">

                    <!-- AI Calorie Logger Section -->
                    <div>
                        <h2 class="font-bold text-xl mb-4">Log Excess Calories with AI</h2>
                        <div class="flex flex-col sm:flex-row gap-4 mb-4">
                            <input id="excessDescInput" type="text"
                                placeholder="Describe the food (e.g., Handful of chips)"
                                class="bg-gray-800 border border-gray-700 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <button id="logExcessBtn" class="btn btn-primary" onclick="app.addExcessCalories()">
                                <svg id="logExcessIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2"
                                    fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4" />
                                </svg>
                                <span id="logExcessText">Calculate & Log</span>
                                <svg id="logExcessSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                                    xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                        stroke-width="4"></circle>
                                    <path class="opacity-75" fill="currentColor"
                                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                    </path>
                                </svg>
                            </button>
                        </div>
                        <div id="excessList" class="space-y-2 text-sm text-gray-300">
                            <!-- Logged items will appear here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column (Trackers) -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Nutrition Hub Card -->
                <div class="card p-6">
                    <h2 class="font-bold text-xl mb-4">Nutrition Hub</h2>
                    <!-- Liquid Calories -->
                    <div class="mb-6">
                        <h3 class="font-semibold text-gray-300 mb-2">Liquid Calories</h3>
                        <p class="text-2xl font-bold text-white"><span id="liquidCaloriesDisplay">0</span> / 500 kcal
                        </p>
                        <div class="progress-bar mt-2 mb-4">
                            <div id="liquidCaloriesBar" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="grid grid-cols-2 gap-2 text-sm">
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(150)">Soda (150)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(120)">Juice (120)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(210)">Choc. Milk
                                (210)</button>
                            <button class="btn btn-secondary" onclick="app.addLiquidCalories(180)">Latte (180)</button>
                        </div>
                    </div>

                    <!-- Water Intake -->
                    <div>
                        <h3 class="font-semibold text-gray-300 mb-2">Water Intake</h3>
                        <p class="text-2xl font-bold text-white"><span id="waterIntakeDisplay">0</span> / 8 Glasses</p>
                        <div class="progress-bar mt-2 mb-4">
                            <div id="waterIntakeBar" class="progress-bar-fill" style="width: 0%;"></div>
                        </div>
                        <div class="flex">
                            <button class="btn btn-secondary w-full" onclick="app.addWater(1)">+1 Glass</button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appUI = {
            authContainer: document.getElementById('auth-container'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logoutBtn'),
            googleSignInBtn: document.getElementById('googleSignInBtn'),
            authError: document.getElementById('auth-error'),
            workoutSelector: document.getElementById('workoutSelector'),
            workoutStack: document.getElementById('workoutStack'),
            liquidCaloriesDisplay: document.getElementById('liquidCaloriesDisplay'),
            liquidCaloriesBar: document.getElementById('liquidCaloriesBar'),
            waterIntakeDisplay: document.getElementById('waterIntakeDisplay'),
            waterIntakeBar: document.getElementById('waterIntakeBar'),
            workoutStreakDisplay: document.getElementById('workoutStreakDisplay'),
            lastWorkoutDate: document.getElementById('lastWorkoutDate'),
            excessCaloriesDisplay: document.getElementById('excessCaloriesDisplay'),
            excessList: document.getElementById('excessList'),
        };

        const app = {
            db: null,
            auth: null,
            userId: null,
            unsubscribe: null,
            state: {},
            workouts: {
                home_abs: { name: 'Home Ab Workout', duration: '15 Mins', exercises: [{ name: 'Push Ups', sets: 3, reps: '10-15' }, { name: 'Crunches', sets: 3, reps: 20 }, { name: 'Leg Raises', sets: 3, reps: 15 }, { name: 'Plank', sets: 3, reps: '60s hold' }, { name: 'Russian Twists', sets: 3, reps: '20 (each side)' },] },
                gym_push: { name: 'Gym: Push Day', duration: '45 Mins', exercises: [{ name: 'Bench Press', sets: 3, reps: '8-12' }, { name: 'Overhead Press', sets: 3, reps: '8-12' }, { name: 'Incline DB Press', sets: 3, reps: '10-15' }, { name: 'Tricep Pushdowns', sets: 3, reps: '12-15' }, { name: 'Lateral Raises', sets: 4, reps: '12-15' },] },
                gym_pull: { name: 'Gym: Pull Day', duration: '45 Mins', exercises: [{ name: 'Pull-Ups / Lat Pulldowns', sets: 3, reps: '8-12' }, { name: 'Bent-Over Rows', sets: 3, reps: '8-12' }, { name: 'Face Pulls', sets: 3, reps: '15-20' }, { name: 'Bicep Curls', sets: 3, reps: '12-15' },] },
                gym_legs: { name: 'Gym: Legs Day', duration: '45 Mins', exercises: [{ name: 'Squats', sets: 3, reps: '8-12' }, { name: 'Romanian Deadlifts', sets: 3, reps: '10-12' }, { name: 'Leg Press', sets: 3, reps: '12-15' }, { name: 'Leg Curls', sets: 3, reps: '12-15' }, { name: 'Calf Raises', sets: 4, reps: '15-20' },] },
                cardio: { name: 'Cardio' },
                rest_day: { name: 'Rest Day' },
            },

            async init() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                const firebaseConfig = {
                    apiKey: "AIzaSyC8Z5uv-7AiSEStw0jBYGvlsmVo9Ly63J4",
                    authDomain: "health-dashboard-c880e.firebaseapp.com",
                    projectId: "health-dashboard-c880e",
                    storageBucket: "health-dashboard-c880e.appspot.com",
                    messagingSenderId: "108872105823",
                    appId: "1:108872105823:web:5a64271ad63cf76b83c0ea"
                };

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSyXXX")) {
                    appUI.authContainer.innerHTML = '<p class="text-red-400 text-center">Firebase configuration is missing or is a placeholder. Please follow the setup guide.</p>';
                    return;
                }
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.auth = getAuth(firebaseApp);
                    this.db = getFirestore(firebaseApp);
                    this.addEventListeners();
                    this.handleAuthState(appId);
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    appUI.authContainer.innerHTML = `<p class="text-red-400 text-center">Error initializing Firebase: ${error.message}</p>`;
                }
            },

            handleAuthState(appId) {
                onAuthStateChanged(this.auth, user => {
                    if (user) {
                        this.userId = user.uid;
                        const welcomeMessage = appUI.appContainer.querySelector('p');
                        if (user.displayName) {
                            welcomeMessage.textContent = `Welcome back, ${user.displayName.split(' ')[0]}! Here's your snapshot for today.`;
                        } else {
                            welcomeMessage.textContent = `Welcome back! Here's your snapshot for today.`;
                        }
                        appUI.authContainer.classList.add('hidden');
                        appUI.appContainer.classList.remove('hidden');
                        this.setupRealtimeListener(appId);
                    } else {
                        this.userId = null;
                        appUI.authContainer.classList.remove('hidden');
                        appUI.appContainer.classList.add('hidden');
                        if (this.unsubscribe) { this.unsubscribe(); }
                    }
                });
            },

            async signInWithGoogle() {
                const provider = new GoogleAuthProvider();
                try {
                    await signInWithPopup(this.auth, provider);
                    appUI.authError.textContent = ''; // Clear any previous errors
                } catch (error) {
                    console.error("Google Sign-In Error:", error);
                    appUI.authError.textContent = `Error signing in: ${error.message}`;
                }
            },

            setupRealtimeListener(appId) {
                if (this.unsubscribe) this.unsubscribe();
                const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'dailyState');
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.state = docSnap.data();
                        this.resetDailyMetricsIfNeeded();
                    } else {
                        this.state = this.getInitialState();
                        this.saveStateToFirestore();
                    }
                    this.render();
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    alert("Could not connect to the database. Please check your connection and refresh.");
                });
            },

            async saveStateToFirestore() {
                if (!this.userId) return;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'dailyState');
                    await setDoc(docRef, this.state, { merge: true });
                } catch (error) {
                    console.error("Error saving state to Firestore:", error);
                }
            },

            getInitialState() {
                const today = new Date().toISOString().split('T')[0];
                return {
                    lastLogin: today,
                    workoutStreak: 0,
                    lastWorkoutDate: '',
                    liquidCalories: 0,
                    waterIntake: 0,
                    excessCalories: 0,
                    excessLog: [],
                    todaysWorkouts: [],
                };
            },

            resetDailyMetricsIfNeeded() {
                const today = new Date().toISOString().split('T')[0];
                if (this.state.lastLogin !== today) {
                    console.log("New day detected. Resetting daily metrics.");
                    this.state.lastLogin = today;
                    this.state.liquidCalories = 0;
                    this.state.waterIntake = 0;
                    this.state.excessCalories = 0;
                    this.state.excessLog = [];
                    this.state.todaysWorkouts = [];

                    const lastWorkout = this.state.lastWorkoutDate ? new Date(this.state.lastWorkoutDate) : null;
                    if (lastWorkout) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (lastWorkout.toDateString() !== yesterday.toDateString() && lastWorkout.toDateString() !== new Date().toDateString()) {
                            this.state.workoutStreak = 0;
                        }
                    }
                    this.saveStateToFirestore();
                }
            },

            addWorkout(workoutId) {
                if (workoutId === 'none') return;
                const workoutData = this.workouts[workoutId];
                if (!workoutData) return;

                const newWorkout = {
                    id: workoutId,
                    instanceId: `workout_${Date.now()}`,
                    name: workoutData.name,
                    isComplete: false,
                };

                if (workoutId === 'cardio') {
                    newWorkout.cardioType = 'Running';
                    newWorkout.duration = 30;
                } else if (workoutId !== 'rest_day') {
                    newWorkout.completedExercises = [];
                }

                this.state.todaysWorkouts.push(newWorkout);
                this.saveStateToFirestore();
                appUI.workoutSelector.value = 'none';
            },

            removeWorkout(instanceId) {
                this.state.todaysWorkouts = this.state.todaysWorkouts.filter(w => w.instanceId !== instanceId);
                this.saveStateToFirestore();
            },

            updateCardioDetails(instanceId, field, value) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout) return;

                if (field === 'duration') {
                    workout[field] = parseInt(value, 10) || 0;
                } else {
                    workout[field] = value;
                }
                this.saveStateToFirestore();
            },

            toggleExercise(instanceId, exerciseName) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout) return;

                const index = workout.completedExercises.indexOf(exerciseName);
                if (index > -1) {
                    workout.completedExercises.splice(index, 1);
                } else {
                    workout.completedExercises.push(exerciseName);
                }
                this.saveStateToFirestore();
            },

            completeWorkout(instanceId) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout || workout.isComplete) return;

                workout.isComplete = true;

                const isFirstCompletion = !this.state.todaysWorkouts.some(w => w.isComplete && w.instanceId !== instanceId);

                if (isFirstCompletion) {
                    const today = new Date().toISOString().split('T')[0];
                    const lastWorkout = this.state.lastWorkoutDate;

                    if (!lastWorkout || lastWorkout !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const lastWorkoutDateObj = lastWorkout ? new Date(lastWorkout) : null;

                        if (lastWorkoutDateObj && lastWorkoutDateObj.toDateString() === yesterday.toDateString()) {
                            this.state.workoutStreak += 1;
                        } else {
                            this.state.workoutStreak = 1;
                        }
                    }
                    this.state.lastWorkoutDate = today;
                }

                this.saveStateToFirestore();
            },

            addLiquidCalories(calories) {
                this.state.liquidCalories = (this.state.liquidCalories || 0) + calories;
                this.saveStateToFirestore();
            },

            addWater(glasses) {
                this.state.waterIntake = (this.state.waterIntake || 0) + glasses;
                this.saveStateToFirestore();
            },

            async addExcessCalories() {
                const descInput = document.getElementById('excessDescInput');
                const desc = descInput.value.trim();
                if (!desc) return;

                const logBtn = document.getElementById('logExcessBtn');
                const logText = document.getElementById('logExcessText');
                const logIcon = document.getElementById('logExcessIcon');
                const logSpinner = document.getElementById('logExcessSpinner');

                logBtn.disabled = true;
                logText.textContent = 'Calculating...';
                logIcon.classList.add('hidden');
                logSpinner.classList.remove('hidden');

                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: `Estimate calories for: ${desc}` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { calories: { type: "NUMBER", description: "Estimated calories for the food item." } }, required: ["calories"] } } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const parsedJson = JSON.parse(candidate.content.parts[0].text);
                        const calories = parsedJson.calories;
                        if (calories > 0) {
                            this.state.excessCalories = (this.state.excessCalories || 0) + calories;
                            this.state.excessLog = this.state.excessLog || [];
                            this.state.excessLog.push({ calories, desc });
                            descInput.value = '';
                            this.saveStateToFirestore();
                        } else throw new Error("Could not estimate calories.");
                    } else throw new Error("Invalid response from API.");
                } catch (error) {
                    console.error("Calorie estimation failed:", error);
                    alert("Sorry, I couldn't estimate the calories for that. Please try a different description.");
                } finally {
                    logBtn.disabled = false;
                    logText.textContent = 'Calculate & Log';
                    logIcon.classList.remove('hidden');
                    logSpinner.classList.add('hidden');
                }
            },

            render() {
                if (!this.state || Object.keys(this.state).length === 0) return;

                appUI.workoutStack.innerHTML = '';
                if (this.state.todaysWorkouts && this.state.todaysWorkouts.length > 0) {
                    this.state.todaysWorkouts.forEach(workout => {
                        let contentHtml = '';
                        if (workout.id === 'rest_day') {
                            contentHtml = `<p class="text-center text-gray-400 p-4">Take a day to recover and recharge.</p>`;
                        } else if (workout.id === 'cardio') {
                            contentHtml = `
                                <div class="space-y-4 p-2">
                                    <div>
                                        <label for="cardioType_${workout.instanceId}" class="block text-sm font-medium text-gray-300 mb-1">Cardio Type</label>
                                        <select id="cardioType_${workout.instanceId}" class="w-full bg-gray-800 border border-gray-700 rounded-md px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'cardioType', this.value)">
                                            <option ${workout.cardioType === 'Running' ? 'selected' : ''}>Running</option>
                                            <option ${workout.cardioType === 'Cycling' ? 'selected' : ''}>Cycling</option>
                                            <option ${workout.cardioType === 'Swimming' ? 'selected' : ''}>Swimming</option>
                                            <option ${workout.cardioType === 'Elliptical' ? 'selected' : ''}>Elliptical</option>
                                            <option ${workout.cardioType === 'Rowing' ? 'selected' : ''}>Rowing</option>
                                            <option ${workout.cardioType === 'Stair Climber' ? 'selected' : ''}>Stair Climber</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="duration_${workout.instanceId}" class="block text-sm font-medium text-gray-300 mb-1">Duration (minutes)</label>
                                        <input type="number" id="duration_${workout.instanceId}" value="${workout.duration}" class="w-full bg-gray-800 border border-gray-700 rounded-md px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'duration', this.value)">
                                    </div>
                                </div>`;
                        } else {
                            const workoutData = this.workouts[workout.id];
                            contentHtml = `<div class="space-y-3">${workoutData.exercises.map(ex => {
                                const isChecked = workout.completedExercises.includes(ex.name);
                                return `<label class="flex items-center p-3 bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700">
                                        <input type="checkbox" class="h-5 w-5 rounded mr-4" onchange="app.toggleExercise('${workout.instanceId}', '${ex.name}')" ${isChecked ? 'checked' : ''}>
                                        <span class="flex-grow text-white">${ex.name}</span>
                                        <span class="text-gray-400">${ex.sets} sets x ${ex.reps} reps</span>
                                    </label>`;
                            }).join('')
                                }</div>`;
                        }

                        appUI.workoutStack.innerHTML += `
                            <div class="border border-gray-700 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-teal-400">${workout.name}</h3>
                                    <button class="btn btn-danger btn-sm py-1 px-2 text-xs" onclick="app.removeWorkout('${workout.instanceId}')">Remove</button>
                                </div>
                                ${contentHtml}
                                <button class="btn btn-primary mt-6 w-full" onclick="app.completeWorkout('${workout.instanceId}')" ${workout.isComplete ? 'disabled' : ''}>
                                    ${workout.isComplete ? 'Completed!' : 'Mark as Complete'}
                                </button>
                            </div>
                        `;
                    });
                } else {
                    appUI.workoutStack.innerHTML = `<p class="text-center text-gray-500 py-4">No workouts added for today.</p>`;
                }

                // Nutrition Section
                appUI.liquidCaloriesDisplay.textContent = this.state.liquidCalories || 0;
                appUI.liquidCaloriesBar.style.width = `${Math.min(100, ((this.state.liquidCalories || 0) / 500) * 100)}%`;
                appUI.waterIntakeDisplay.textContent = this.state.waterIntake || 0;
                appUI.waterIntakeBar.style.width = `${Math.min(100, ((this.state.waterIntake || 0) / 8) * 100)}%`;

                appUI.excessCaloriesDisplay.textContent = this.state.excessCalories || 0;
                appUI.excessList.innerHTML = (this.state.excessLog || []).map(item =>
                    `<div class="flex justify-between items-center bg-gray-800 p-2 rounded-md">
                        <span>${item.desc}</span>
                        <span class="font-semibold text-teal-400">${item.calories} kcal</span>
                    </div>`
                ).join('');

                // Stats Section
                appUI.workoutStreakDisplay.textContent = this.state.workoutStreak || 0;
                appUI.lastWorkoutDate.textContent = this.state.lastWorkoutDate ? `Last workout: ${new Date(this.state.lastWorkoutDate).toLocaleDateString()}` : 'No workouts yet.';
            },

            addEventListeners() {
                appUI.logoutBtn.addEventListener('click', () => signOut(this.auth));
                appUI.googleSignInBtn.addEventListener('click', () => this.signInWithGoogle());
                appUI.workoutSelector.addEventListener('change', (e) => this.addWorkout(e.target.value));
            }
        };

        app.init();
        window.app = app; // Make app globally accessible for inline event handlers

    </script>
</body>

</html>