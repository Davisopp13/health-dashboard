<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Personal Health Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #111827;
            /* Darker background */
            color: #E5E7EB;
            /* Light gray text */
        }

        .card {
            background-color: #1F2937;
            /* Dark card background */
            border: 1px solid #374151;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        .btn {
            border-radius: 0.5rem;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .btn-primary {
            background-color: #14B8A6;
            /* Teal */
            color: white;
        }

        .btn-primary:hover {
            background-color: #0D9488;
        }

        .btn-secondary {
            background-color: #4B5563;
            /* Gray */
            color: white;
        }

        .btn-secondary:hover {
            background-color: #374151;
        }

        .btn-danger {
            background-color: #991B1B;
            /* Dark Red */
            color: white;
        }

        .btn-danger:hover {
            background-color: #7F1D1D;
        }

        .progress-bar {
            background-color: #374151;
            border-radius: 9999px;
            overflow: hidden;
            height: 1rem;
        }

        .progress-bar-fill {
            background-color: #14B8A6;
            transition: width 0.3s ease-in-out;
        }

        input[type="checkbox"]:checked+span {
            text-decoration: line-through;
            color: #6B7280;
        }

        input[type="checkbox"] {
            accent-color: #14B8A6;
        }
    </style>
</head>

<body class="p-4 sm:p-6 md:p-8">

    <div id="auth-container">
        <div class="max-w-md mx-auto mt-20 card text-center">
            <h1 class="text-3xl font-bold text-white mb-2">Health Dashboard</h1>
            <p class="text-gray-400 mb-6">Please log in to continue</p>
            <div id="loading-auth" class="flex items-center justify-center">
                <svg class="animate-spin h-8 w-8 text-teal-500" xmlns="http://www.w3.org/2000/svg" fill="none"
                    viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor"
                        d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                    </path>
                </svg>
                <span class="ml-4 text-lg">Authenticating...</span>
            </div>
        </div>
    </div>

    <div id="app-container" class="max-w-7xl mx-auto hidden">
        <!-- Header -->
        <header class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8">
            <div>
                <h1 class="text-3xl font-bold text-white">Your Daily Dashboard</h1>
                <p class="text-gray-400 mt-1">Welcome back! Here's your snapshot for the day.</p>
                <p id="userIdDisplay" class="text-xs text-gray-500 mt-2 break-all"></p>
            </div>
            <button id="logoutBtn" class="btn btn-secondary mt-4 sm:mt-0">Logout</button>
        </header>

        <!-- Main Content Grid -->
        <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">

            <!-- Left & Middle Columns -->
            <div class="lg:col-span-2 space-y-6">
                <!-- Today's Workout -->
                <div class="card">
                    <h2 class="font-bold text-xl mb-4">Today's Workouts</h2>
                    <div class="mb-4">
                        <select id="workoutSelector"
                            class="w-full bg-gray-700 border border-gray-600 rounded-md px-3 py-2 focus:outline-none focus:ring-2 focus:ring-teal-500">
                            <option value="none">-- Add a workout to your day --</option>
                            <option value="home_abs">Home Ab Workout (15 Mins)</option>
                            <option value="gym_push">Gym: Push Day (45 Mins)</option>
                            <option value="gym_pull">Gym: Pull Day (45 Mins)</option>
                            <option value="gym_legs">Gym: Legs Day (45 Mins)</option>
                            <option value="cardio">Cardio</option>
                            <option value="rest_day">Rest Day</option>
                        </select>
                    </div>
                    <div id="workoutStack" class="space-y-6">
                        <!-- Dynamically added workout blocks will appear here -->
                    </div>
                </div>

                <!-- AI Calorie Logger -->
                <div class="card">
                    <h2 class="font-bold text-xl mb-4">Log Excess Calories with AI</h2>
                    <div class="flex flex-col sm:flex-row gap-4 mb-4">
                        <input id="excessDescInput" type="text" placeholder="Describe the food (e.g., Handful of chips)"
                            class="bg-gray-700 border border-gray-600 rounded-md px-3 py-2 w-full focus:outline-none focus:ring-2 focus:ring-teal-500">
                        <button id="logExcessBtn" class="btn btn-primary" onclick="app.addExcessCalories()">
                            <svg id="logExcessIcon" xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2"
                                viewBox="0 0 20 20" fill="currentColor">
                                <path
                                    d="M5 3a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2V5a2 2 0 00-2-2H5zM5 11a2 2 0 00-2 2v2a2 2 0 002 2h2a2 2 0 002-2v-2a2 2 0 00-2-2H5zM11 5a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V5zM14 11a1 1 0 011 1v1h1a1 1 0 110 2h-1v1a1 1 0 11-2 0v-1h-1a1 1 0 110-2h1v-1a1 1 0 011-1z" />
                            </svg>
                            <span id="logExcessText">Calculate & Log</span>
                            <svg id="logExcessSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor"
                                    stroke-width="4"></circle>
                                <path class="opacity-75" fill="currentColor"
                                    d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z">
                                </path>
                            </svg>
                        </button>
                    </div>
                    <div id="excessList" class="space-y-2 text-sm text-gray-300">
                        <!-- Logged items will appear here -->
                    </div>
                </div>
            </div>

            <!-- Right Column -->
            <div class="space-y-6">
                <!-- Liquid Calories -->
                <div class="card">
                    <h2 class="font-bold text-xl mb-4">Liquid Calories</h2>
                    <p class="text-2xl font-bold text-white"><span id="liquidCaloriesDisplay">0</span> / 500 kcal</p>
                    <div class="progress-bar mt-2 mb-4">
                        <div id="liquidCaloriesBar" class="progress-bar-fill" style="width: 0%;"></div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 text-sm">
                        <button class="btn btn-secondary" onclick="app.addLiquidCalories(150)">Soda (150)</button>
                        <button class="btn btn-secondary" onclick="app.addLiquidCalories(120)">Juice (120)</button>
                        <button class="btn btn-secondary" onclick="app.addLiquidCalories(210)">Choc. Milk (210)</button>
                        <button class="btn btn-secondary" onclick="app.addLiquidCalories(180)">Latte (180)</button>
                    </div>
                </div>

                <!-- Water Intake -->
                <div class="card">
                    <h2 class="font-bold text-xl mb-4">Water Intake</h2>
                    <p class="text-2xl font-bold text-white"><span id="waterIntakeDisplay">0</span> / 8 Glasses</p>
                    <div class="progress-bar mt-2 mb-4">
                        <div id="waterIntakeBar" class="progress-bar-fill" style="width: 0%;"></div>
                    </div>
                    <div class="flex justify-center">
                        <button class="btn btn-secondary" onclick="app.addWater(1)">+1 Glass</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 sm:grid-cols-2 gap-6">
                    <!-- Workout Streak -->
                    <div class="card flex flex-col items-center justify-center text-center">
                        <h2 class="font-bold text-xl mb-2">Workout Streak</h2>
                        <div class="flex items-baseline">
                            <span id="workoutStreakDisplay" class="text-6xl font-bold text-teal-400">0</span>
                            <span class="text-xl font-semibold ml-2 text-gray-400">Days</span>
                        </div>
                        <p id="lastWorkoutDate" class="text-sm text-gray-500 mt-1">No workouts yet.</p>
                    </div>

                    <!-- Total Excess Calories -->
                    <div class="card flex flex-col items-center justify-center text-center">
                        <h2 class="font-bold text-xl mb-2">Total Excess Calories</h2>
                        <span id="excessCaloriesDisplay" class="text-6xl font-bold text-teal-400">0</span>
                        <p class="text-xl font-semibold ml-2 text-gray-400">kcal</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Firebase SDK -->
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged, signOut, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, setDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appUI = {
            authContainer: document.getElementById('auth-container'),
            loadingAuth: document.getElementById('loading-auth'),
            appContainer: document.getElementById('app-container'),
            logoutBtn: document.getElementById('logoutBtn'),
            userIdDisplay: document.getElementById('userIdDisplay'),
            workoutSelector: document.getElementById('workoutSelector'),
            workoutStack: document.getElementById('workoutStack'), // Changed from exerciseList
            liquidCaloriesDisplay: document.getElementById('liquidCaloriesDisplay'),
            liquidCaloriesBar: document.getElementById('liquidCaloriesBar'),
            waterIntakeDisplay: document.getElementById('waterIntakeDisplay'),
            waterIntakeBar: document.getElementById('waterIntakeBar'),
            workoutStreakDisplay: document.getElementById('workoutStreakDisplay'),
            lastWorkoutDate: document.getElementById('lastWorkoutDate'),
            excessCaloriesDisplay: document.getElementById('excessCaloriesDisplay'),
            excessList: document.getElementById('excessList'),
        };

        const app = {
            db: null,
            auth: null,
            userId: null,
            unsubscribe: null,
            state: {},
            workouts: {
                home_abs: { name: 'Home Ab Workout', duration: '15 Mins', exercises: [{ name: 'Push Ups', sets: 3, reps: '10-15' }, { name: 'Crunches', sets: 3, reps: 20 }, { name: 'Leg Raises', sets: 3, reps: 15 }, { name: 'Plank', sets: 3, reps: '60s hold' }, { name: 'Russian Twists', sets: 3, reps: '20 (each side)' },] },
                gym_push: { name: 'Gym: Push Day', duration: '45 Mins', exercises: [{ name: 'Bench Press', sets: 3, reps: '8-12' }, { name: 'Overhead Press', sets: 3, reps: '8-12' }, { name: 'Incline DB Press', sets: 3, reps: '10-15' }, { name: 'Tricep Pushdowns', sets: 3, reps: '12-15' }, { name: 'Lateral Raises', sets: 4, reps: '12-15' },] },
                gym_pull: { name: 'Gym: Pull Day', duration: '45 Mins', exercises: [{ name: 'Pull-Ups / Lat Pulldowns', sets: 3, reps: '8-12' }, { name: 'Bent-Over Rows', sets: 3, reps: '8-12' }, { name: 'Face Pulls', sets: 3, reps: '15-20' }, { name: 'Bicep Curls', sets: 3, reps: '12-15' },] },
                gym_legs: { name: 'Gym: Legs Day', duration: '45 Mins', exercises: [{ name: 'Squats', sets: 3, reps: '8-12' }, { name: 'Romanian Deadlifts', sets: 3, reps: '10-12' }, { name: 'Leg Press', sets: 3, reps: '12-15' }, { name: 'Leg Curls', sets: 3, reps: '12-15' }, { name: 'Calf Raises', sets: 4, reps: '15-20' },] },
                cardio: { name: 'Cardio' },
                rest_day: { name: 'Rest Day' },
            },

            async init() {
                const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

                // --- START: PASTE YOUR FIREBASE CONFIG HERE ---
                // Replace this object with the firebaseConfig object from your Firebase project console.
                // This is a critical step for connecting the app to your backend.
                const firebaseConfig = {
                    apiKey: "AIzaSyC8Z5uv-7AiSEStw0jBYGvlsmVo9Ly63J4",
                    authDomain: "health-dashboard-c880e.firebaseapp.com",
                    projectId: "health-dashboard-c880e",
                    storageBucket: "health-dashboard-c880e.appspot.com",
                    messagingSenderId: "108872105823",
                    appId: "1:108872105823:web:5a64271ad63cf76b83c0ea"
                };
                // --- END: PASTE YOUR FIREBASE CONFIG HERE ---

                const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.startsWith("AIzaSyXXX")) {
                    appUI.loadingAuth.innerHTML = '<p class="text-red-400">Firebase configuration is missing or is a placeholder. Please follow the setup guide.</p>';
                    return;
                }
                try {
                    const firebaseApp = initializeApp(firebaseConfig);
                    this.auth = getAuth(firebaseApp);
                    this.db = getFirestore(firebaseApp);
                    this.addEventListeners();
                    this.handleAuthState(initialAuthToken, appId);
                } catch (error) {
                    console.error("Firebase Initialization Error:", error);
                    appUI.loadingAuth.innerHTML = `<p class="text-red-400">Error initializing Firebase: ${error.message}</p>`;
                }
            },

            handleAuthState(token, appId) {
                onAuthStateChanged(this.auth, user => {
                    if (user) {
                        this.userId = user.uid;
                        appUI.authContainer.classList.add('hidden');
                        appUI.appContainer.classList.remove('hidden');
                        appUI.userIdDisplay.textContent = `User ID: ${this.userId}`;
                        this.setupRealtimeListener(appId);
                    } else {
                        this.userId = null;
                        appUI.authContainer.classList.remove('hidden');
                        appUI.appContainer.classList.add('hidden');
                        if (this.unsubscribe) { this.unsubscribe(); }
                        this.signIn(token);
                    }
                });
            },

            async signIn(token) {
                try {
                    await setPersistence(this.auth, browserLocalPersistence);
                    if (token) {
                        try {
                            await signInWithCustomToken(this.auth, token);
                        } catch (error) {
                            if (error.code === 'auth/custom-token-mismatch') {
                                console.warn("Custom token mismatch detected. This can happen if the token is for a different Firebase project. Falling back to anonymous sign-in.");
                                await signInAnonymously(this.auth);
                            } else {
                                throw error; // Re-throw other types of errors
                            }
                        }
                    } else {
                        await signInAnonymously(this.auth);
                    }
                } catch (error) {
                    console.error("Authentication Error:", error);
                    appUI.loadingAuth.innerHTML = `<p class="text-red-400">Authentication failed: ${error.message}</p>`;
                }
            },

            setupRealtimeListener(appId) {
                if (this.unsubscribe) this.unsubscribe();
                const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'dailyState');
                this.unsubscribe = onSnapshot(docRef, (docSnap) => {
                    if (docSnap.exists()) {
                        this.state = docSnap.data();
                        this.resetDailyMetricsIfNeeded();
                    } else {
                        this.state = this.getInitialState();
                        this.saveStateToFirestore();
                    }
                    this.render();
                }, (error) => {
                    console.error("Firestore Snapshot Error:", error);
                    alert("Could not connect to the database. Please check your connection and refresh.");
                });
            },

            async saveStateToFirestore() {
                if (!this.userId) return;
                try {
                    const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
                    const docRef = doc(this.db, 'artifacts', appId, 'users', this.userId, 'data', 'dailyState');
                    await setDoc(docRef, this.state, { merge: true });
                } catch (error) {
                    console.error("Error saving state to Firestore:", error);
                }
            },

            getInitialState() {
                const today = new Date().toISOString().split('T')[0];
                return {
                    lastLogin: today,
                    workoutStreak: 0,
                    lastWorkoutDate: '',
                    liquidCalories: 0,
                    waterIntake: 0,
                    excessCalories: 0,
                    excessLog: [],
                    todaysWorkouts: [], // Changed data structure
                };
            },

            resetDailyMetricsIfNeeded() {
                const today = new Date().toISOString().split('T')[0];
                if (this.state.lastLogin !== today) {
                    console.log("New day detected. Resetting daily metrics.");
                    this.state.lastLogin = today;
                    this.state.liquidCalories = 0;
                    this.state.waterIntake = 0;
                    this.state.excessCalories = 0;
                    this.state.excessLog = [];
                    this.state.todaysWorkouts = [];

                    const lastWorkout = this.state.lastWorkoutDate ? new Date(this.state.lastWorkoutDate) : null;
                    if (lastWorkout) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        if (lastWorkout.toDateString() !== yesterday.toDateString() && lastWorkout.toDateString() !== new Date().toDateString()) {
                            this.state.workoutStreak = 0;
                        }
                    }
                    this.saveStateToFirestore();
                }
            },

            addWorkout(workoutId) {
                if (workoutId === 'none') return;
                const workoutData = this.workouts[workoutId];
                if (!workoutData) return;

                const newWorkout = {
                    id: workoutId,
                    instanceId: `workout_${Date.now()}`,
                    name: workoutData.name,
                    isComplete: false,
                };

                // Add specific properties for different workout types
                if (workoutId === 'cardio') {
                    newWorkout.cardioType = 'Running'; // default value
                    newWorkout.duration = 30; // default value
                } else if (workoutId !== 'rest_day') {
                    newWorkout.completedExercises = [];
                }

                this.state.todaysWorkouts.push(newWorkout);
                this.saveStateToFirestore();
                appUI.workoutSelector.value = 'none'; // Reset dropdown
            },

            removeWorkout(instanceId) {
                this.state.todaysWorkouts = this.state.todaysWorkouts.filter(w => w.instanceId !== instanceId);
                this.saveStateToFirestore();
            },

            updateCardioDetails(instanceId, field, value) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout) return;

                if (field === 'duration') {
                    workout[field] = parseInt(value, 10) || 0;
                } else {
                    workout[field] = value;
                }
                this.saveStateToFirestore();
            },

            toggleExercise(instanceId, exerciseName) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout) return;

                const index = workout.completedExercises.indexOf(exerciseName);
                if (index > -1) {
                    workout.completedExercises.splice(index, 1);
                } else {
                    workout.completedExercises.push(exerciseName);
                }
                this.saveStateToFirestore();
            },

            completeWorkout(instanceId) {
                const workout = this.state.todaysWorkouts.find(w => w.instanceId === instanceId);
                if (!workout || workout.isComplete) return;

                workout.isComplete = true;

                // Check if this is the first workout completed today to update streak
                const isFirstCompletion = !this.state.todaysWorkouts.some(w => w.isComplete && w.instanceId !== instanceId);

                if (isFirstCompletion) {
                    const today = new Date().toISOString().split('T')[0];
                    const lastWorkout = this.state.lastWorkoutDate;

                    if (!lastWorkout || lastWorkout !== today) {
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        const lastWorkoutDateObj = lastWorkout ? new Date(lastWorkout) : null;

                        if (lastWorkoutDateObj && lastWorkoutDateObj.toDateString() === yesterday.toDateString()) {
                            this.state.workoutStreak += 1;
                        } else {
                            this.state.workoutStreak = 1;
                        }
                    }
                    this.state.lastWorkoutDate = today;
                }

                this.saveStateToFirestore();
            },

            addLiquidCalories(calories) {
                this.state.liquidCalories = (this.state.liquidCalories || 0) + calories;
                this.saveStateToFirestore();
            },

            addWater(glasses) {
                this.state.waterIntake = (this.state.waterIntake || 0) + glasses;
                this.saveStateToFirestore();
            },

            async addExcessCalories() {
                const descInput = document.getElementById('excessDescInput');
                const desc = descInput.value.trim();
                if (!desc) return;

                const logBtn = document.getElementById('logExcessBtn');
                const logText = document.getElementById('logExcessText');
                const logIcon = document.getElementById('logExcessIcon');
                const logSpinner = document.getElementById('logExcessSpinner');

                logBtn.disabled = true;
                logText.textContent = 'Calculating...';
                logIcon.classList.add('hidden');
                logSpinner.classList.remove('hidden');

                try {
                    const apiKey = "";
                    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-05-20:generateContent?key=${apiKey}`;
                    const payload = { contents: [{ parts: [{ text: `Estimate calories for: ${desc}` }] }], generationConfig: { responseMimeType: "application/json", responseSchema: { type: "OBJECT", properties: { calories: { type: "NUMBER", description: "Estimated calories for the food item." } }, required: ["calories"] } } };
                    const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                    if (!response.ok) throw new Error(`API error: ${response.statusText}`);
                    const result = await response.json();
                    const candidate = result.candidates?.[0];

                    if (candidate && candidate.content?.parts?.[0]?.text) {
                        const parsedJson = JSON.parse(candidate.content.parts[0].text);
                        const calories = parsedJson.calories;
                        if (calories > 0) {
                            this.state.excessCalories = (this.state.excessCalories || 0) + calories;
                            this.state.excessLog = this.state.excessLog || [];
                            this.state.excessLog.push({ calories, desc });
                            descInput.value = '';
                            this.saveStateToFirestore();
                        } else throw new Error("Could not estimate calories.");
                    } else throw new Error("Invalid response from API.");
                } catch (error) {
                    console.error("Calorie estimation failed:", error);
                    alert("Sorry, I couldn't estimate the calories for that. Please try a different description.");
                } finally {
                    logBtn.disabled = false;
                    logText.textContent = 'Calculate & Log';
                    logIcon.classList.remove('hidden');
                    logSpinner.classList.add('hidden');
                }
            },

            render() {
                if (!this.state || Object.keys(this.state).length === 0) return;

                // Render Workout Stack
                appUI.workoutStack.innerHTML = '';
                if (this.state.todaysWorkouts && this.state.todaysWorkouts.length > 0) {
                    this.state.todaysWorkouts.forEach(workout => {
                        let contentHtml = '';
                        // Conditionally render content based on workout type
                        if (workout.id === 'rest_day') {
                            contentHtml = `<p class="text-center text-gray-400 p-4">Take a day to recover and recharge.</p>`;
                        } else if (workout.id === 'cardio') {
                            contentHtml = `
                                <div class="space-y-4 p-2">
                                    <div>
                                        <label for="cardioType_${workout.instanceId}" class="block text-sm font-medium text-gray-300 mb-1">Cardio Type</label>
                                        <select id="cardioType_${workout.instanceId}" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'cardioType', this.value)">
                                            <option ${workout.cardioType === 'Running' ? 'selected' : ''}>Running</option>
                                            <option ${workout.cardioType === 'Cycling' ? 'selected' : ''}>Cycling</option>
                                            <option ${workout.cardioType === 'Swimming' ? 'selected' : ''}>Swimming</option>
                                            <option ${workout.cardioType === 'Elliptical' ? 'selected' : ''}>Elliptical</option>
                                            <option ${workout.cardioType === 'Rowing' ? 'selected' : ''}>Rowing</option>
                                            <option ${workout.cardioType === 'Stair Climber' ? 'selected' : ''}>Stair Climber</option>
                                        </select>
                                    </div>
                                    <div>
                                        <label for="duration_${workout.instanceId}" class="block text-sm font-medium text-gray-300 mb-1">Duration (minutes)</label>
                                        <input type="number" id="duration_${workout.instanceId}" value="${workout.duration}" class="w-full bg-gray-800 border border-gray-600 rounded-md px-3 py-2" onchange="app.updateCardioDetails('${workout.instanceId}', 'duration', this.value)">
                                    </div>
                                </div>`;
                        } else {
                            const workoutData = this.workouts[workout.id];
                            contentHtml = `<div class="space-y-3">${workoutData.exercises.map(ex => {
                                const isChecked = workout.completedExercises.includes(ex.name);
                                return `<label class="flex items-center p-3 bg-gray-800 rounded-md cursor-pointer hover:bg-gray-700">
                                        <input type="checkbox" class="h-5 w-5 rounded mr-4" onchange="app.toggleExercise('${workout.instanceId}', '${ex.name}')" ${isChecked ? 'checked' : ''}>
                                        <span class="flex-grow text-white">${ex.name}</span>
                                        <span class="text-gray-400">${ex.sets} sets x ${ex.reps} reps</span>
                                    </label>`;
                            }).join('')
                                }</div>`;
                        }

                        appUI.workoutStack.innerHTML += `
                            <div class="border border-gray-700 rounded-lg p-4">
                                <div class="flex justify-between items-center mb-4">
                                    <h3 class="font-bold text-lg text-teal-400">${workout.name}</h3>
                                    <button class="btn btn-danger btn-sm py-1 px-2 text-xs" onclick="app.removeWorkout('${workout.instanceId}')">Remove</button>
                                </div>
                                ${contentHtml}
                                <button class="btn btn-primary mt-6 w-full" onclick="app.completeWorkout('${workout.instanceId}')" ${workout.isComplete ? 'disabled' : ''}>
                                    ${workout.isComplete ? 'Completed!' : 'Mark as Complete'}
                                </button>
                            </div>
                        `;
                    });
                } else {
                    appUI.workoutStack.innerHTML = `<p class="text-center text-gray-500">No workouts added for today.</p>`;
                }

                // Nutrition Section
                appUI.liquidCaloriesDisplay.textContent = this.state.liquidCalories || 0;
                appUI.liquidCaloriesBar.style.width = `${Math.min(100, ((this.state.liquidCalories || 0) / 500) * 100)}%`;
                appUI.waterIntakeDisplay.textContent = this.state.waterIntake || 0;
                appUI.waterIntakeBar.style.width = `${Math.min(100, ((this.state.waterIntake || 0) / 8) * 100)}%`;
                appUI.excessCaloriesDisplay.textContent = this.state.excessCalories || 0;
                appUI.excessList.innerHTML = (this.state.excessLog || []).map(item =>
                    `<div class="flex justify-between items-center bg-gray-800 p-2 rounded-md">
                        <span>${item.desc}</span>
                        <span class="font-semibold text-teal-400">${item.calories} kcal</span>
                    </div>`
                ).join('');

                // Stats Section
                appUI.workoutStreakDisplay.textContent = this.state.workoutStreak || 0;
                appUI.lastWorkoutDate.textContent = this.state.lastWorkoutDate ? `Last workout: ${new Date(this.state.lastWorkoutDate).toLocaleDateString()}` : 'No workouts yet.';
            },

            addEventListeners() {
                appUI.logoutBtn.addEventListener('click', () => signOut(this.auth));
                appUI.workoutSelector.addEventListener('change', (e) => this.addWorkout(e.target.value));
            }
        };

        app.init();
        window.app = app; // Make app globally accessible for inline event handlers

    </script>
</body>

</html>